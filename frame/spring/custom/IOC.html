<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>IOC | 技术小站</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="logo.ico">
    <meta name="description" content="生活不止眼前的代码，还有迈向田野的步伐">
    
    <link rel="preload" href="/blog/assets/css/0.styles.803dc0c7.css" as="style"><link rel="preload" href="/blog/assets/js/app.36c7cd49.js" as="script"><link rel="preload" href="/blog/assets/js/2.5c52e41f.js" as="script"><link rel="preload" href="/blog/assets/js/1.65a7fcd1.js" as="script"><link rel="preload" href="/blog/assets/js/99.e2a05ce2.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.a209d3a9.js"><link rel="prefetch" href="/blog/assets/js/100.41067c0c.js"><link rel="prefetch" href="/blog/assets/js/101.5e48ee63.js"><link rel="prefetch" href="/blog/assets/js/102.996da4fc.js"><link rel="prefetch" href="/blog/assets/js/103.4ad9a9ed.js"><link rel="prefetch" href="/blog/assets/js/104.dbbf376c.js"><link rel="prefetch" href="/blog/assets/js/105.474c76df.js"><link rel="prefetch" href="/blog/assets/js/106.64ee5b81.js"><link rel="prefetch" href="/blog/assets/js/107.4e2c303f.js"><link rel="prefetch" href="/blog/assets/js/108.6df8df47.js"><link rel="prefetch" href="/blog/assets/js/109.f9a6b25c.js"><link rel="prefetch" href="/blog/assets/js/11.9b471693.js"><link rel="prefetch" href="/blog/assets/js/110.cd289f4f.js"><link rel="prefetch" href="/blog/assets/js/111.de5b0344.js"><link rel="prefetch" href="/blog/assets/js/112.602ad505.js"><link rel="prefetch" href="/blog/assets/js/113.d9f1cd37.js"><link rel="prefetch" href="/blog/assets/js/114.c39c0da9.js"><link rel="prefetch" href="/blog/assets/js/115.79153770.js"><link rel="prefetch" href="/blog/assets/js/116.14b62c34.js"><link rel="prefetch" href="/blog/assets/js/117.be545b11.js"><link rel="prefetch" href="/blog/assets/js/118.50059393.js"><link rel="prefetch" href="/blog/assets/js/119.95ac2812.js"><link rel="prefetch" href="/blog/assets/js/12.a4ba3c93.js"><link rel="prefetch" href="/blog/assets/js/120.8609e349.js"><link rel="prefetch" href="/blog/assets/js/121.578e1010.js"><link rel="prefetch" href="/blog/assets/js/122.09187353.js"><link rel="prefetch" href="/blog/assets/js/123.7d6498a1.js"><link rel="prefetch" href="/blog/assets/js/124.bfa3d2c7.js"><link rel="prefetch" href="/blog/assets/js/125.af694e98.js"><link rel="prefetch" href="/blog/assets/js/126.1ef3d5c4.js"><link rel="prefetch" href="/blog/assets/js/127.aa57cac7.js"><link rel="prefetch" href="/blog/assets/js/128.1be22387.js"><link rel="prefetch" href="/blog/assets/js/129.26d8f73e.js"><link rel="prefetch" href="/blog/assets/js/13.384ea083.js"><link rel="prefetch" href="/blog/assets/js/130.68df5112.js"><link rel="prefetch" href="/blog/assets/js/131.ab94ddeb.js"><link rel="prefetch" href="/blog/assets/js/132.34eafedb.js"><link rel="prefetch" href="/blog/assets/js/133.180e2732.js"><link rel="prefetch" href="/blog/assets/js/134.e896b99a.js"><link rel="prefetch" href="/blog/assets/js/135.bee74f41.js"><link rel="prefetch" href="/blog/assets/js/136.d82aa22e.js"><link rel="prefetch" href="/blog/assets/js/137.339a5cb1.js"><link rel="prefetch" href="/blog/assets/js/138.5f7f7327.js"><link rel="prefetch" href="/blog/assets/js/139.7d667235.js"><link rel="prefetch" href="/blog/assets/js/14.6b8495d3.js"><link rel="prefetch" href="/blog/assets/js/140.ca69053a.js"><link rel="prefetch" href="/blog/assets/js/141.10f8759f.js"><link rel="prefetch" href="/blog/assets/js/142.f01f6545.js"><link rel="prefetch" href="/blog/assets/js/143.09617cd6.js"><link rel="prefetch" href="/blog/assets/js/144.80ac3552.js"><link rel="prefetch" href="/blog/assets/js/145.e8687bbb.js"><link rel="prefetch" href="/blog/assets/js/146.dede65cc.js"><link rel="prefetch" href="/blog/assets/js/147.deadcc6d.js"><link rel="prefetch" href="/blog/assets/js/148.97f6e203.js"><link rel="prefetch" href="/blog/assets/js/149.2201847b.js"><link rel="prefetch" href="/blog/assets/js/15.6818b7fd.js"><link rel="prefetch" href="/blog/assets/js/150.3d5ee53c.js"><link rel="prefetch" href="/blog/assets/js/151.cc45301a.js"><link rel="prefetch" href="/blog/assets/js/152.8393b4bc.js"><link rel="prefetch" href="/blog/assets/js/153.a106e956.js"><link rel="prefetch" href="/blog/assets/js/154.a12f38ce.js"><link rel="prefetch" href="/blog/assets/js/155.44eee9c3.js"><link rel="prefetch" href="/blog/assets/js/156.81d3a0eb.js"><link rel="prefetch" href="/blog/assets/js/157.d310f46e.js"><link rel="prefetch" href="/blog/assets/js/158.e7f3a78e.js"><link rel="prefetch" href="/blog/assets/js/159.55fc4a79.js"><link rel="prefetch" href="/blog/assets/js/16.341b7272.js"><link rel="prefetch" href="/blog/assets/js/160.8505bb9c.js"><link rel="prefetch" href="/blog/assets/js/161.4ce6ae0d.js"><link rel="prefetch" href="/blog/assets/js/162.7febda5f.js"><link rel="prefetch" href="/blog/assets/js/163.0144012c.js"><link rel="prefetch" href="/blog/assets/js/164.51b5fdeb.js"><link rel="prefetch" href="/blog/assets/js/165.9add3fc7.js"><link rel="prefetch" href="/blog/assets/js/166.3bea6bca.js"><link rel="prefetch" href="/blog/assets/js/167.77295bbf.js"><link rel="prefetch" href="/blog/assets/js/168.796c33be.js"><link rel="prefetch" href="/blog/assets/js/169.76a3f357.js"><link rel="prefetch" href="/blog/assets/js/17.16d9fbd4.js"><link rel="prefetch" href="/blog/assets/js/170.87faa96f.js"><link rel="prefetch" href="/blog/assets/js/171.5a01afac.js"><link rel="prefetch" href="/blog/assets/js/172.03904c56.js"><link rel="prefetch" href="/blog/assets/js/173.896758dd.js"><link rel="prefetch" href="/blog/assets/js/174.696e0a2c.js"><link rel="prefetch" href="/blog/assets/js/175.dfb72a35.js"><link rel="prefetch" href="/blog/assets/js/176.4c756b08.js"><link rel="prefetch" href="/blog/assets/js/177.92495f99.js"><link rel="prefetch" href="/blog/assets/js/178.6c90af23.js"><link rel="prefetch" href="/blog/assets/js/179.8aaf5715.js"><link rel="prefetch" href="/blog/assets/js/18.be4afb08.js"><link rel="prefetch" href="/blog/assets/js/180.c28b2e77.js"><link rel="prefetch" href="/blog/assets/js/181.a2150557.js"><link rel="prefetch" href="/blog/assets/js/182.608d7533.js"><link rel="prefetch" href="/blog/assets/js/183.dcd7caf3.js"><link rel="prefetch" href="/blog/assets/js/184.14f9c859.js"><link rel="prefetch" href="/blog/assets/js/185.2627ab6e.js"><link rel="prefetch" href="/blog/assets/js/19.a4adc151.js"><link rel="prefetch" href="/blog/assets/js/20.46ef1aca.js"><link rel="prefetch" href="/blog/assets/js/21.2be5744a.js"><link rel="prefetch" href="/blog/assets/js/22.7799aa96.js"><link rel="prefetch" href="/blog/assets/js/23.de99ed79.js"><link rel="prefetch" href="/blog/assets/js/24.b7fbd8f4.js"><link rel="prefetch" href="/blog/assets/js/25.e0286b4a.js"><link rel="prefetch" href="/blog/assets/js/26.25782bdf.js"><link rel="prefetch" href="/blog/assets/js/27.f4b90a64.js"><link rel="prefetch" href="/blog/assets/js/28.ef890190.js"><link rel="prefetch" href="/blog/assets/js/29.5f6a6a8f.js"><link rel="prefetch" href="/blog/assets/js/3.2f24c6d9.js"><link rel="prefetch" href="/blog/assets/js/30.fae9ceba.js"><link rel="prefetch" href="/blog/assets/js/31.a337e21a.js"><link rel="prefetch" href="/blog/assets/js/32.3c61104d.js"><link rel="prefetch" href="/blog/assets/js/33.b2f0a1b2.js"><link rel="prefetch" href="/blog/assets/js/34.f1170830.js"><link rel="prefetch" href="/blog/assets/js/35.a4de42af.js"><link rel="prefetch" href="/blog/assets/js/36.5fbe3d1c.js"><link rel="prefetch" href="/blog/assets/js/37.b0806903.js"><link rel="prefetch" href="/blog/assets/js/38.1a359170.js"><link rel="prefetch" href="/blog/assets/js/39.debd2e6a.js"><link rel="prefetch" href="/blog/assets/js/4.3977a209.js"><link rel="prefetch" href="/blog/assets/js/40.3ca4f646.js"><link rel="prefetch" href="/blog/assets/js/41.ebf9559b.js"><link rel="prefetch" href="/blog/assets/js/42.ee04f8a7.js"><link rel="prefetch" href="/blog/assets/js/43.88fcdf2d.js"><link rel="prefetch" href="/blog/assets/js/44.b5442fb9.js"><link rel="prefetch" href="/blog/assets/js/45.d5eb94fd.js"><link rel="prefetch" href="/blog/assets/js/46.8d875464.js"><link rel="prefetch" href="/blog/assets/js/47.52966fd1.js"><link rel="prefetch" href="/blog/assets/js/48.1f6739e5.js"><link rel="prefetch" href="/blog/assets/js/49.5aa04920.js"><link rel="prefetch" href="/blog/assets/js/5.93b2f136.js"><link rel="prefetch" href="/blog/assets/js/50.f2d3a23c.js"><link rel="prefetch" href="/blog/assets/js/51.580088b2.js"><link rel="prefetch" href="/blog/assets/js/52.4bb244fd.js"><link rel="prefetch" href="/blog/assets/js/53.9cc70af4.js"><link rel="prefetch" href="/blog/assets/js/54.fce0e522.js"><link rel="prefetch" href="/blog/assets/js/55.45218aad.js"><link rel="prefetch" href="/blog/assets/js/56.4a7b7f70.js"><link rel="prefetch" href="/blog/assets/js/57.a3032426.js"><link rel="prefetch" href="/blog/assets/js/58.c1a20724.js"><link rel="prefetch" href="/blog/assets/js/59.40a8e3f9.js"><link rel="prefetch" href="/blog/assets/js/6.8429dd54.js"><link rel="prefetch" href="/blog/assets/js/60.853ed1b4.js"><link rel="prefetch" href="/blog/assets/js/61.ee6c50dc.js"><link rel="prefetch" href="/blog/assets/js/62.5d2b3ad5.js"><link rel="prefetch" href="/blog/assets/js/63.8a27742e.js"><link rel="prefetch" href="/blog/assets/js/64.0b936975.js"><link rel="prefetch" href="/blog/assets/js/65.26802909.js"><link rel="prefetch" href="/blog/assets/js/66.36e30bea.js"><link rel="prefetch" href="/blog/assets/js/67.52fde5d5.js"><link rel="prefetch" href="/blog/assets/js/68.cf9db5a8.js"><link rel="prefetch" href="/blog/assets/js/69.2e2ba572.js"><link rel="prefetch" href="/blog/assets/js/7.337526f4.js"><link rel="prefetch" href="/blog/assets/js/70.df0ee471.js"><link rel="prefetch" href="/blog/assets/js/71.3f772ca6.js"><link rel="prefetch" href="/blog/assets/js/72.83f1b4cd.js"><link rel="prefetch" href="/blog/assets/js/73.ddf41ff8.js"><link rel="prefetch" href="/blog/assets/js/74.769fc5ad.js"><link rel="prefetch" href="/blog/assets/js/75.a68bc8c9.js"><link rel="prefetch" href="/blog/assets/js/76.61cd3314.js"><link rel="prefetch" href="/blog/assets/js/77.3c8f94c8.js"><link rel="prefetch" href="/blog/assets/js/78.c9e84a16.js"><link rel="prefetch" href="/blog/assets/js/79.0b64cc47.js"><link rel="prefetch" href="/blog/assets/js/80.43fb5a5e.js"><link rel="prefetch" href="/blog/assets/js/81.b4477c62.js"><link rel="prefetch" href="/blog/assets/js/82.5d46377b.js"><link rel="prefetch" href="/blog/assets/js/83.f793c7c7.js"><link rel="prefetch" href="/blog/assets/js/84.23cde58c.js"><link rel="prefetch" href="/blog/assets/js/85.e86969ef.js"><link rel="prefetch" href="/blog/assets/js/86.5df619a3.js"><link rel="prefetch" href="/blog/assets/js/87.ff656821.js"><link rel="prefetch" href="/blog/assets/js/88.8db93b7c.js"><link rel="prefetch" href="/blog/assets/js/89.671e61e0.js"><link rel="prefetch" href="/blog/assets/js/90.d42a0038.js"><link rel="prefetch" href="/blog/assets/js/91.a03ac2f8.js"><link rel="prefetch" href="/blog/assets/js/92.d5c60cff.js"><link rel="prefetch" href="/blog/assets/js/93.25ce91da.js"><link rel="prefetch" href="/blog/assets/js/94.e0ef0edd.js"><link rel="prefetch" href="/blog/assets/js/95.05e9349f.js"><link rel="prefetch" href="/blog/assets/js/96.22ebe11f.js"><link rel="prefetch" href="/blog/assets/js/97.9f61fcd1.js"><link rel="prefetch" href="/blog/assets/js/98.2cf0c871.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.ef62c33d.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.803dc0c7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">技术小站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/jvm/" class="nav-link">
  JVM
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/concurrent/" class="nav-link">
  高并发
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/io/" class="nav-link">
  IO
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/cache/" class="nav-link">
  缓存
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/collection/" class="nav-link">
  集合
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frame/spring/" class="nav-link router-link-active">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/blog/frame/mybatis/" class="nav-link">
  MyBatis
</a></li><li class="dropdown-item"><!----> <a href="/blog/frame/springboot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/blog/frame/springcloud/" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/blog/frame/netty/" class="nav-link">
  Netty
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/database/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/blog/database/redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><span class="title">进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="进阶" class="mobile-dropdown-title"><span class="title">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/middleware/es/" class="nav-link">
  Elasticsearch
</a></li><li class="dropdown-item"><!----> <a href="/blog/middleware/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/blog/middleware/k8s/" class="nav-link">
  Kubernetes
</a></li></ul></div></div><div class="nav-item"><a href="/blog/design/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/blog/util/" class="nav-link">
  工具向
</a></div><div class="nav-item"><a href="/blog/project/" class="nav-link">
  项目总结
</a></div><div class="nav-item"><a href="/blog/personal/" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/jvm/" class="nav-link">
  JVM
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/concurrent/" class="nav-link">
  高并发
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/io/" class="nav-link">
  IO
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/cache/" class="nav-link">
  缓存
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/collection/" class="nav-link">
  集合
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frame/spring/" class="nav-link router-link-active">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/blog/frame/mybatis/" class="nav-link">
  MyBatis
</a></li><li class="dropdown-item"><!----> <a href="/blog/frame/springboot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/blog/frame/springcloud/" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/blog/frame/netty/" class="nav-link">
  Netty
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/database/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/blog/database/redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><span class="title">进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="进阶" class="mobile-dropdown-title"><span class="title">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/middleware/es/" class="nav-link">
  Elasticsearch
</a></li><li class="dropdown-item"><!----> <a href="/blog/middleware/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/blog/middleware/k8s/" class="nav-link">
  Kubernetes
</a></li></ul></div></div><div class="nav-item"><a href="/blog/design/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/blog/util/" class="nav-link">
  工具向
</a></div><div class="nav-item"><a href="/blog/project/" class="nav-link">
  项目总结
</a></div><div class="nav-item"><a href="/blog/personal/" class="nav-link">
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring框架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/frame/spring/Spring框架概述.html" class="sidebar-link">Spring框架概述</a></li><li><a href="/blog/frame/spring/ApplicationContext和BeanFactory区别.html" class="sidebar-link">ApplicationContext和BeanFactory区别</a></li><li><a href="/blog/frame/spring/BeanFactory和FactoryBean总结.html" class="sidebar-link">BeanFactory和FactoryBean总结</a></li><li><a href="/blog/frame/spring/Spring中Bean的作用域.html" class="sidebar-link">Spring中Bean的作用域</a></li><li><a href="/blog/frame/spring/Spring中Bean加载流程.html" class="sidebar-link">Spring中Bean加载流程</a></li><li><a href="/blog/frame/spring/Spring中Bean加载流程.html" class="sidebar-link">Spring中Bean加载流程</a></li><li><a href="/blog/frame/spring/Spring依赖注入.html" class="sidebar-link">Spring依赖注入</a></li><li><a href="/blog/frame/spring/Spring如何解决循环依赖.html" class="sidebar-link">Spring如何解决循环依赖</a></li><li><a href="/blog/frame/spring/AOP.html" class="sidebar-link">AOP</a></li><li><a href="/blog/frame/spring/Spring事务总结.html" class="sidebar-link">Spring事务总结</a></li><li><a href="/blog/frame/spring/Aware接口.html" class="sidebar-link">Aware接口</a></li><li><a href="/blog/frame/spring/Spi机制.html" class="sidebar-link">Spi机制</a></li><li><a href="/blog/frame/spring/Spring配置文件加载顺序.html" class="sidebar-link">Spring配置文件加载顺序</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>使用总结</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/frame/spring/Spring自定义注解扫描.html" class="sidebar-link">Spring自定义注解扫描</a></li><li><a href="/blog/frame/spring/ByteBuddy实现动态代理.html" class="sidebar-link">ByteBuddy实现动态代理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>手写Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/frame/spring/custom/手写Spring.html" class="sidebar-link">手写Spring</a></li><li><a href="/blog/frame/spring/custom/IOC.html" aria-current="page" class="active sidebar-link">IOC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#扫描类-resourceresolver" class="sidebar-link">扫描类 - ResourceResolver</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#配置项注入-propertyresolver" class="sidebar-link">配置项注入 - PropertyResolver</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#扫描bean" class="sidebar-link">扫描Bean</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#bean注入" class="sidebar-link">@Bean注入</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#创建-beandefinition" class="sidebar-link">创建 BeanDefinition</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#beandefinition" class="sidebar-link">BeanDefinition</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#工厂方法和工厂名称" class="sidebar-link">工厂方法和工厂名称</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#创建逻辑" class="sidebar-link">创建逻辑</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#创建bean" class="sidebar-link">创建Bean</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#spring依赖注入" class="sidebar-link">Spring依赖注入</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#依赖注入四种方法" class="sidebar-link">依赖注入四种方法</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#循环依赖的问题" class="sidebar-link">循环依赖的问题</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#带入参的构造方法-工厂方法" class="sidebar-link">带入参的构造方法/工厂方法</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#入参类型" class="sidebar-link">入参类型</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#创建bean的过程" class="sidebar-link">创建Bean的过程</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#强依赖检测" class="sidebar-link">强依赖检测</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#创建bean的方式" class="sidebar-link">创建Bean的方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#初始化bean" class="sidebar-link">初始化Bean</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#属性注入" class="sidebar-link">属性注入</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#字段属性注入" class="sidebar-link">字段属性注入</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#方法属性注入" class="sidebar-link">方法属性注入</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#beanpostprocessor" class="sidebar-link">BeanPostProcessor</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#测试" class="sidebar-link">测试</a></li><li class="sidebar-sub-header"><a href="/blog/frame/spring/custom/IOC.html#注入原则" class="sidebar-link">注入原则</a></li></ul></li></ul></li><li><a href="/blog/frame/spring/custom/AOP.html" class="sidebar-link">AOP</a></li><li><a href="/blog/frame/spring/custom/JDBC.html" class="sidebar-link">JDBC</a></li><li><a href="/blog/frame/spring/custom/声明式事务.html" class="sidebar-link">声明式事务</a></li><li><a href="/blog/frame/spring/custom/MVC.html" class="sidebar-link">MVC实现逻辑</a></li><li><a href="/blog/frame/spring/custom/Boot.html" class="sidebar-link">Boot</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ioc"><a href="#ioc" class="header-anchor">#</a> IOC</h1> <p>其中构造方法注入和工厂方法注入是强依赖，因为Bean创建和属性注入放到一起了。</p> <p>比如构造方法注入，创建对象的同时进行属性注入，这种属于强依赖。</p> <p>而强依赖是解决不了循环依赖的问题的，因为创建对象和属性注入属于一体不可分的。</p> <p>我们解决循环依赖是先创建对象，然后属性注入的时候利用三级缓存解决的。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">BeanTest</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;spring.port&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> port<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>IOC容器有两类，BeanFactory 和 ApplicationContext。</p> <ul><li>BeanFactory 延迟创建 Bean。</li> <li>ApplicationContext 启动时初始化所有 Bean。</li></ul> <p>Summer Framework也仅实现Annotation配置+<code>@ComponentScan</code>扫描方式完成容器的配置。</p> <h2 id="扫描类-resourceresolver"><a href="#扫描类-resourceresolver" class="header-anchor">#</a> 扫描类 - ResourceResolver</h2> <ol><li>扫描指定文件夹下的所有类</li> <li>扫描指定jar包下的所有类</li></ol> <h2 id="配置项注入-propertyresolver"><a href="#配置项注入-propertyresolver" class="header-anchor">#</a> 配置项注入 - PropertyResolver</h2> <ul><li>加载配置文件 application.properties 里面的配置项到内存中。</li> <li>扫描@Value注解</li></ul> <blockquote><p>注解类似标识，给类或者方法增加注解标识，后续通过扫描注解可以实现注解具体的功能。</p></blockquote> <h2 id="扫描bean"><a href="#扫描bean" class="header-anchor">#</a> 扫描Bean</h2> <ol><li>扫描指定包下所有的类
<ul><li>扫描@Component下所有的类</li> <li>扫描@Import导入的类</li></ul></li> <li>加载需要放入容器的Bean
<ul><li>扫描加了@Component注解的类</li> <li>扫描加了@Configuration的类
<ul><li><p>同时扫描配置类里面加了@Bean注解的方法，作为Bean注入。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//扫描Configuration注解</span>
<span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>configuration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//扫描Configuration注解里面的@Bean</span>
    <span class="token function">scanFactoryMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> defs<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

<span class="token keyword">var</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">,</span> beanClass<span class="token punctuation">,</span> factoryBeanName<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token function">getOrder</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        method<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">Primary</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token comment">// init method:</span>
                        bean<span class="token punctuation">.</span><span class="token function">initMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> bean<span class="token punctuation">.</span><span class="token function">initMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token comment">// destroy method:</span>
                        bean<span class="token punctuation">.</span><span class="token function">destroyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> bean<span class="token punctuation">.</span><span class="token function">destroyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token comment">// @PostConstruct / @PreDestroy method:</span>
                        <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li></ul></li></ul></li></ol> <h3 id="bean注入"><a href="#bean注入" class="header-anchor">#</a> @Bean注入</h3> <p>可以指定该Bean 注入，同时指定 initMethod 和 destroyMethod 方法。</p> <p>注入的Bean可以是普通 Java 类。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * @Configuration扫描注入Bean的同时，会扫描该类的所有方法
     * 将加了@Bean注解的方法也注入进来
     * methodName作为BeanName，返回值作为BeanClass
     * @param helloService
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>initMethod <span class="token operator">=</span> <span class="token string">&quot;init&quot;</span><span class="token punctuation">,</span>destroyMethod <span class="token operator">=</span> <span class="token string">&quot;destory&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">HelloB</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">HelloService</span> helloService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HelloB</span><span class="token punctuation">(</span>helloService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="创建-beandefinition"><a href="#创建-beandefinition" class="header-anchor">#</a> 创建 BeanDefinition</h2> <h3 id="beandefinition"><a href="#beandefinition" class="header-anchor">#</a> BeanDefinition</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanDefinition</span> <span class="token punctuation">{</span>

    <span class="token comment">//全局唯一 beanName</span>
    <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token comment">//Bean声明类型</span>
    <span class="token comment">//声明类型和实际类型有区别</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">;</span>

    <span class="token comment">//Bean实例对象</span>
    <span class="token class-name">Object</span> instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">//构造方法</span>
    <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> constructor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">//工厂方法名称</span>
    <span class="token class-name">String</span> factoryName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">//工厂方法</span>
    <span class="token class-name">String</span> factoryMethod <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">//Bean顺序</span>
    <span class="token keyword">int</span> order<span class="token punctuation">;</span>

    <span class="token comment">//是否标识@Primary</span>
    <span class="token comment">//类型相同的Bean，配置了该注解的优先使用</span>
    <span class="token keyword">boolean</span> primary<span class="token punctuation">;</span>

    <span class="token class-name">String</span> initMethodName<span class="token punctuation">;</span>

    <span class="token class-name">String</span> destroyMethodName<span class="token punctuation">;</span>

    <span class="token comment">//init/destroy方法</span>
    <span class="token comment">//对应 @PostConstruct和 @PreDestroy 方法</span>
    <span class="token class-name">Method</span> initMethod<span class="token punctuation">;</span>
  
    <span class="token class-name">Method</span> destroyMethod<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><ul><li><p>beanClass是声明类型</p> <p>比如DataSource是声明类型，但是Bean的实际类型是它的子类 HikariDataSource。</p> <p>不过BeanDefinition中需要的是声明类型，因为实际类型可以通过 bean.getClass 直接获得：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>initMethod<span class="token operator">=</span><span class="token string">&quot;init&quot;</span><span class="token punctuation">,</span> destroyMethod<span class="token operator">=</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">DataSource</span> <span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HikariDataSource</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>Order</p> <p>相同 Class 类型 Bean 设置执行顺序</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> <span class="token function">findBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beans<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//类型过滤</span>
                <span class="token comment">//isAssignableFrom()方法用于判断当前Class对象所表示的类或接口是否可以被指定的另一个Class对象所表示的类或接口所赋值。</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>def <span class="token operator">-&gt;</span> type<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span> definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//比较order</span>
        <span class="token keyword">int</span> compare <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>order<span class="token punctuation">,</span> definition<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>compare <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> compare<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//order相同再比较name</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p>primary</p> <p>类型相同的Bean，优先使用加了该注解的Bean。</p> <ul><li>类型相同的Bean只允许指定一个@primary。</li> <li>获取到之后只将标注了@primary的Bean返回。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token class-name">BeanDefinition</span> <span class="token function">findBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//查询某个类型下所有Bean，包含子类、实现类</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> beanDefinitions <span class="token operator">=</span> <span class="token function">findBeanDefinitions</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinitions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//找到唯一一个Bean</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> beanDefinitions<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//more than 1 beans,require @Primary</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> primaryDefs <span class="token operator">=</span> beanDefinitions<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token operator">::</span><span class="token function">isPrimary</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//@Primary唯一标注的Bean</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>primaryDefs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> primaryDefs<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>primaryDefs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoUniqueBeanDefinitionException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Multiple bean with type '%s' found, but no @Primary specified.&quot;</span><span class="token punctuation">,</span> type<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoUniqueBeanDefinitionException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Multiple bean with type '%s' found, and multiple @Primary specified.&quot;</span><span class="token punctuation">,</span> type<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div></li></ul> <h3 id="工厂方法和工厂名称"><a href="#工厂方法和工厂名称" class="header-anchor">#</a> 工厂方法和工厂名称</h3> <p>在Spring里面，加了@Configuration注解的类就是一个工厂类。</p> <p>加了@Bean的方法都是一个工厂方法，对应一个Bean。</p> <blockquote><p>也就是说@Configuration的类需要遍历注入多个Bean，在创建普通Bean之前要先把@Configuration对应的工厂类创建出来。</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">scanFactoryMethods</span><span class="token punctuation">(</span><span class="token class-name">String</span> factoryBeanName<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> defs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> method <span class="token operator">:</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//扫描方法上的@Bean注解</span>
            <span class="token class-name">Bean</span> bean <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Bean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> mod <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//abstract</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionException</span><span class="token punctuation">(</span><span class="token string">&quot;@Bean method &quot;</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; must not be abstract.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//final</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isFinal</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionException</span><span class="token punctuation">(</span><span class="token string">&quot;@Bean method &quot;</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; must not be final.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//private</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPrivate</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionException</span><span class="token punctuation">(</span><span class="token string">&quot;@Bean method &quot;</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; must not be private.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>beanClass<span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionException</span><span class="token punctuation">(</span><span class="token string">&quot;@Bean method &quot;</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; must not return primitive type.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>beanClass <span class="token operator">==</span> <span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">||</span> beanClass <span class="token operator">==</span> <span class="token class-name">Void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionException</span><span class="token punctuation">(</span><span class="token string">&quot;@Bean method &quot;</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; must not return void.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">var</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">,</span> beanClass<span class="token punctuation">,</span> factoryBeanName<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token function">getOrder</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        method<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">Primary</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token comment">// init method:</span>
                        bean<span class="token punctuation">.</span><span class="token function">initMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> bean<span class="token punctuation">.</span><span class="token function">initMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token comment">// destroy method:</span>
                        bean<span class="token punctuation">.</span><span class="token function">destroyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> bean<span class="token punctuation">.</span><span class="token function">destroyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token comment">// @PostConstruct / @PreDestroy method:</span>
                        <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">addBeanDefinitions</span><span class="token punctuation">(</span>defs<span class="token punctuation">,</span> def<span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;define bean: {}&quot;</span><span class="token punctuation">,</span> def<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="创建逻辑"><a href="#创建逻辑" class="header-anchor">#</a> 创建逻辑</h3> <p>根据扫描到的 Bean 创建 BeanDefinition。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 根据扫描的ClassName创建BeanDefinition
     */</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> <span class="token function">createBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> classNameSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> defs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> className <span class="token operator">:</span> classNameSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 反射获取Class</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//Annotation、enum、interface、record不需要加载</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">isAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> clazz<span class="token punctuation">.</span><span class="token function">isEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> clazz<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> clazz<span class="token punctuation">.</span><span class="token function">isRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 是否标注@Component?</span>
            <span class="token class-name">Component</span> component <span class="token operator">=</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>component <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;found component: &quot;</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> mod <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionException</span><span class="token punctuation">(</span><span class="token string">&quot;@Component class &quot;</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; must not be abstract.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPrivate</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionException</span><span class="token punctuation">(</span><span class="token string">&quot;@Component class &quot;</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; must not be private.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token function">getSuitableConstructor</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getOrder</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">,</span> clazz<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">Primary</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token comment">// named init / destroy method:</span>
                        <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                        <span class="token comment">// 扫描@PostConstruct注解</span>
                        <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotationMethod</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token class-name">PostConstruct</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token comment">// 扫描@PreDestroy注解</span>
                        <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotationMethod</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token class-name">PreDestroy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">addBeanDefinitions</span><span class="token punctuation">(</span>defs<span class="token punctuation">,</span> def<span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;define bean: {}&quot;</span><span class="token punctuation">,</span> def<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//扫描Configuration注解</span>
                <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//扫描Configuration注解里面的@Bean</span>
                    <span class="token function">scanFactoryMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> defs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> defs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h2 id="创建bean"><a href="#创建bean" class="header-anchor">#</a> 创建Bean</h2> <h3 id="spring依赖注入"><a href="#spring依赖注入" class="header-anchor">#</a> Spring依赖注入</h3> <h3 id="依赖注入四种方法"><a href="#依赖注入四种方法" class="header-anchor">#</a> 依赖注入四种方法</h3> <ul><li><p>构造方法注入</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">HelloA</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">HelloService</span> helloService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>helloService <span class="token operator">=</span> helloService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>工厂方法注入</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>initMethod <span class="token operator">=</span> <span class="token string">&quot;init&quot;</span><span class="token punctuation">,</span> destroyMethod <span class="token operator">=</span> <span class="token string">&quot;destory&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">HelloB</span> <span class="token function">helloB</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">HelloService</span> helloService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HelloB</span><span class="token punctuation">(</span>helloService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>set方法注入</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">HelloC</span> <span class="token function">setHelloService</span><span class="token punctuation">(</span><span class="token class-name">HelloService</span> helloService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>helloService <span class="token operator">=</span> helloService<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>字段注入</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">HelloService</span> helloService<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul> <h3 id="循环依赖的问题"><a href="#循环依赖的问题" class="header-anchor">#</a> 循环依赖的问题</h3> <p>其中<strong>构造方法注入和工厂方法注入是强依赖</strong>，因为Bean创建和属性注入放到一起了。</p> <p>比如构造方法注入，创建对象的同时进行属性注入，这种属于强依赖。</p> <p>而强依赖是解决不了循环依赖的问题的，因为创建对象和属性注入属于一体不可分的。</p> <p>我们解决循环依赖是先创建对象，然后属性注入的时候利用三级缓存解决的。</p> <h3 id="带入参的构造方法-工厂方法"><a href="#带入参的构造方法-工厂方法" class="header-anchor">#</a> 带入参的构造方法/工厂方法</h3> <p>构造方法所有参数都需要被Spring管理，不然Spring无法创建Bean实例，因为不知道给入参填充具体什么值。</p> <p>比如入参包含普通类型字段。</p> <p><img src="Spring0c673815-8e8c-4dca-ab06-1de85f1373cc%E6%89%8B%E5%86%99Spring23fc0f0a-d000-42b6-9681-5aa128214394IOC2502bfa8-c6a2-4991-92c0-277b7f63bb00image.png" alt=""></p> <aside>
💡 所以我们在创建Bean的过程中，需要校验构造方法或者工厂方法的入参，如果没有被Spring管理，Spring不知道应该如何为这个属性提供一个合适的值。因此，它抛出一个BeanCreationException 异常，以指示配置错误。
</aside> <h3 id="入参类型"><a href="#入参类型" class="header-anchor">#</a> 入参类型</h3> <p>在Spring中，构造方法和工厂方法注入Bean的时候，入参能使用的注解只包含<code>@Autowired</code>和<code>@Value</code>。</p> <ul><li><p><code>@Autowired</code>用于依赖注入，即注入其他由Spring管理的bean。</p> <p>@Autowired 注解是按照类型注入，需要保证容器中只有一个该类型的Bean 或者 就要加<code>@Primary</code>注解标识优先使用哪个Bean。</p> <p><img src="Spring0c673815-8e8c-4dca-ab06-1de85f1373cc%E6%89%8B%E5%86%99Spring23fc0f0a-d000-42b6-9681-5aa128214394IOC2502bfa8-c6a2-4991-92c0-277b7f63bb00image_1.png" alt=""></p></li> <li><p><code>@Value</code>用于设置基本类型或字符串类型的值，这些值通常来自配置文件或其他非bean资源。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">BeanTest</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spring.port =&gt;&quot;</span> <span class="token operator">+</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul> <h3 id="创建bean的过程"><a href="#创建bean的过程" class="header-anchor">#</a> 创建Bean的过程</h3> <p>对于IOC容器来说，创建Bean过程分为两步。</p> <ol><li><p>创建Bean实例，注入强依赖。</p> <p>如果遇到循环依赖直接报错，因为解决不了。</p></li> <li><p>属性注入</p> <p>对Bean实例进行属性注入，包括 <strong>set 方法注入</strong> 和 <strong>字段注入</strong>。</p></li></ol> <h3 id="强依赖检测"><a href="#强依赖检测" class="header-anchor">#</a> 强依赖检测</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token comment">//首先进行循环依赖检测</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>createingBeanNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//重复创建Bean导致的循环依赖</span>
            <span class="token comment">//强依赖抛出异常</span>
            <span class="token comment">//比如创建某个Bean的时候，先把Bean添加到set中。然后执行构造方法，触发循环依赖，发现set已经包含了该Bean</span>
            <span class="token comment">//A-&gt;B, B-&gt;A</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedDependencyException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="创建bean的方式"><a href="#创建bean的方式" class="header-anchor">#</a> 创建Bean的方式</h3> <p>先进行第一步，创建Bean实例，注入强依赖。</p> <ol><li><p>构造方法创建对象</p></li> <li><p>工厂方法创建对象</p> <p>@Configuration类里面标注了@Bean注解的方法，都是工厂方法对应的Bean对象。</p></li> <li><p>校验 @Configuration类型的Bean。</p> <p>@Configuration类型的Bean是工厂，不允许使用@Autowired创建:</p> <blockquote><p>因为会导致潜在的循环依赖，比如 @Configuration-&gt;A， A-&gt;B, @Configuration里面的@Bean包含B，而B只能在@Configuration初始化之后初始化。</p></blockquote></li> <li><p>校验入参</p> <p>入参要求必须包含<code>@Autowired</code>和<code>@Value</code>注解，不然就抛出 <code>BeanCreationException</code>。</p></li> <li><p>解析入参</p> <ul><li>如果是@Value注入，从PropertyResolver中获取指定配置。</li> <li>如果是@Autowired注入，则递归创建依赖的Bean的实例。</li></ul></li> <li><p>创建Bean实例</p></li></ol> <h2 id="初始化bean"><a href="#初始化bean" class="header-anchor">#</a> 初始化Bean</h2> <p>Spring依赖注入的其中两种方式，set方式和字段注入都发生在初始化Bean阶段。</p> <p>此时Bean实例已经创建出来了，可以给Bean实例进行属性注入了。</p> <h3 id="属性注入"><a href="#属性注入" class="header-anchor">#</a> 属性注入</h3> <p>属性需要是<code>@Value</code>或<code>@Autowired</code>注解修饰。</p> <ul><li><p>static修饰的字段无法注入</p></li> <li><p>final修饰的字段无法注入。</p> <p>因为属性注入节点是在创建Bean之后，而final修饰的字段在创建Bean过程已经初始化了。在属性注入节点无法修改其内容。所以不能注入final修饰的字段属性。</p></li></ul> <p><img src="Spring0c673815-8e8c-4dca-ab06-1de85f1373cc%E6%89%8B%E5%86%99Spring23fc0f0a-d000-42b6-9681-5aa128214394IOC2502bfa8-c6a2-4991-92c0-277b7f63bb00image_2.png" alt=""></p> <ul><li>注入需要同时注入父类的属性到当前Bean</li></ul> <h3 id="字段属性注入"><a href="#字段属性注入" class="header-anchor">#</a> 字段属性注入</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">HelloA</span> helloA<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;server.port&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> value<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li><p>解析@Value注解，获取获取@Value注解真实配置，反射设置为字段真实值。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token comment">//@Value注入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取@Value注解真实配置</span>
            <span class="token class-name">Object</span> propValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>propertyResolver<span class="token punctuation">.</span><span class="token function">getRequiredProperty</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accessibleType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>field <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Field injection: {}.{} = {}&quot;</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accessibleName<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//设置obj的某个字段值</span>
                field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>解析@Autowired注解</p> <p>从 BeanDefinition 工厂中，找到注入Bean的实例，作为属性值设置给当前Bean</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//@Autowired注入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>autowired <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> autowired<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> required <span class="token operator">=</span> autowired<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取属性对应的Bean实例</span>
            <span class="token class-name">Object</span> depends <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">findBean</span><span class="token punctuation">(</span>accessibleType<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">findBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> accessibleType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//bean not found</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>required <span class="token operator">&amp;&amp;</span> depends <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedDependencyException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Dependency bean not found when inject %s.%s for bean '%s': %s&quot;</span><span class="token punctuation">,</span> clazz<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        accessibleName<span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>depends <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>field <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Field injection: {}.{} = {}&quot;</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accessibleName<span class="token punctuation">,</span> depends<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//属性对应的beanObj，设置为bean的field值</span>
                    field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> depends<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Mield injection: {}.{} ({})&quot;</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accessibleName<span class="token punctuation">,</span> depends<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将对象作为入参传入，并执行bean对应的method</span>
                    method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> depends<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></li></ul> <h3 id="方法属性注入"><a href="#方法属性注入" class="header-anchor">#</a> 方法属性注入</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">HelloService</span> helloService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> port<span class="token punctuation">;</span>

    <span class="token comment">/**
     * set方法注入
     *
     * @param helloService
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">Test</span> <span class="token function">setHelloService</span><span class="token punctuation">(</span><span class="token class-name">HelloService</span> helloService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>helloService <span class="token operator">=</span> helloService<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @Value
     *
     * @param port
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHelloService</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;server.port&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>initMethod <span class="token operator">=</span> <span class="token string">&quot;init&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">SpecifyInitBean</span> <span class="token function">createSpecifyInitBean</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${app.title}&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> appTitle<span class="token punctuation">,</span> <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${app.version}&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> appVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SpecifyInitBean</span><span class="token punctuation">(</span>appTitle<span class="token punctuation">,</span> appVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><ul><li><p>解析@Value注解，获取获取@Value注解真实配置，作为入参调用方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token comment">//@Value注入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> propValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>propertyResolver<span class="token punctuation">.</span><span class="token function">getRequiredProperty</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accessibleType<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">//@Value在method级别，只能作为入参</span>
            <span class="token comment">//然后类似执行普通方法一样调用所在方法</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Method injection: {}.{} ({})&quot;</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accessibleName<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//调用了obj的method，并传入入参propValue</span>
                method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p>解析@Autowired注解</p> <p>从 BeanDefinition 工厂中，找到注入Bean的实例，作为入参调用该Method。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//@Autowired注入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>autowired <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> autowired<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> required <span class="token operator">=</span> autowired<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取属性对应的Bean实例</span>
            <span class="token class-name">Object</span> depends <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">findBean</span><span class="token punctuation">(</span>accessibleType<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">findBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> accessibleType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//bean not found</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>required <span class="token operator">&amp;&amp;</span> depends <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedDependencyException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Dependency bean not found when inject %s.%s for bean '%s': %s&quot;</span><span class="token punctuation">,</span> clazz<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        accessibleName<span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>depends <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Mield injection: {}.{} ({})&quot;</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> accessibleName<span class="token punctuation">,</span> depends<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将对象作为入参传入，并执行bean对应的method</span>
                    method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> depends<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li></ul> <h2 id="beanpostprocessor"><a href="#beanpostprocessor" class="header-anchor">#</a> BeanPostProcessor</h2> <p>BeanPostProcessor 支持替换 Bean 或者增强 Bean，常被用于AOP场景。</p> <p>每个Bean在创建的时候都要执行所有的BeanPostProcessor方法。</p> <p>走完BeanPostProcessor方法后的beanObj有可能改变。这样就会产生BeanName不变，BeanObj改变的情况。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token comment">//调用BeanPostProcessor处理Bean</span>
        <span class="token comment">//每个Bean在创建的时候要执行所有的BeanPostProcessor方法</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> beanPostProcessor <span class="token operator">:</span> beanPostProcessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//BeanPostProcessor的before方法</span>
            <span class="token comment">//增强Bean或者AOP</span>
            <span class="token class-name">Object</span> processed <span class="token operator">=</span> beanPostProcessor<span class="token punctuation">.</span><span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>processed <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;PostBeanProcessor returns null when process bean '%s' by %s&quot;</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果BeanPostProcessor替换了原始Bean，需要更换Bean的引用。</span>
            <span class="token comment">//ProxyObj在这里发生了</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> processed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Bean '{}' was replaced by post processor {}.&quot;</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanPostProcessors<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                def<span class="token punctuation">.</span><span class="token function">setInstance</span><span class="token punctuation">(</span>processed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>BeanPostProcessor的用法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">BeanPostProcessor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">StudentService</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">StudentService</span> studentService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StudentService</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
            studentService<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">&quot;albert@gmail.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> studentService<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h3> <ol><li><p>没有继承关系的类</p> <ul><li>beanName不变，beanType改变</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 测试增强类无继承管理
     * beanName不变，beanType改变
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBeanPostProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StudentServiceProxy</span> studentService <span class="token operator">=</span> <span class="token class-name">SpringUtil</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;studentService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>studentService<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;albert@gmail.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>studentService<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;com.albert.spring.bean.StudentServiceProxy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p>有继承关系的类</p> <ul><li>beanName不变，beanType改变</li> <li>目前Bean对象对应的是子类，但是通过父类也可以调用到子类实例。</li></ul> <blockquote><p>StudentService已经脱离了IoC容器的管理，因为此时StudentService对应的BeanDefinition中，存放的instance是StudentServiceProxy。</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 测试存在继承关系
     * beanName不变，beanType改变
     *
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBeanPostProcessor2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//java支持向上转型，子类实例可以当作父类实例来使用</span>
        <span class="token class-name">StudentService</span> studentService <span class="token operator">=</span> <span class="token class-name">SpringUtil</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">StudentService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>studentService<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;com.albert.spring.bean.StudentServiceProxy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>studentService<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;proxy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//子类方法</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span>studentService<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//obj的字段属性，其实就是proxy的字段。而不是父类的字段属性</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNull</span><span class="token punctuation">(</span>studentService<span class="token punctuation">.</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li></ol> <h3 id="注入原则"><a href="#注入原则" class="header-anchor">#</a> 注入原则</h3> <p>一个Bean如果被Proxy替换。</p> <ul><li>依赖它的Bean应该注入Proxy。</li></ul> <ol><li>，则依赖它的Bean应注入Proxy，即上图的<code>MvcController</code>应注入<code>UserServiceProxy</code>；</li> <li>一个Bean如果被Proxy替换，如果要注入依赖，则应该注入到原始对象，即上图的<code>JdbcTemplate</code>应注入到原始的<code>UserService</code>。</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2025-05-30 17:18:01</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/frame/spring/custom/手写Spring.html" class="prev">
        手写Spring
      </a></span> <span class="next"><a href="/blog/frame/spring/custom/AOP.html">
        AOP
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.36c7cd49.js" defer></script><script src="/blog/assets/js/2.5c52e41f.js" defer></script><script src="/blog/assets/js/1.65a7fcd1.js" defer></script><script src="/blog/assets/js/99.e2a05ce2.js" defer></script>
  </body>
</html>
