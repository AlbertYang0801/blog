<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ThreadLocal总结 | 技术小站</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="logo.ico">
    <meta name="description" content="生活不止眼前的代码，还有迈向田野的步伐">
    
    <link rel="preload" href="/blog/assets/css/0.styles.069fd700.css" as="style"><link rel="preload" href="/blog/assets/js/app.20191c45.js" as="script"><link rel="preload" href="/blog/assets/js/2.7ded94f8.js" as="script"><link rel="preload" href="/blog/assets/js/64.00e9edf7.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.5574c8e6.js"><link rel="prefetch" href="/blog/assets/js/100.b89e075a.js"><link rel="prefetch" href="/blog/assets/js/101.548085bc.js"><link rel="prefetch" href="/blog/assets/js/102.f1954004.js"><link rel="prefetch" href="/blog/assets/js/103.405cd27b.js"><link rel="prefetch" href="/blog/assets/js/104.7837f3a8.js"><link rel="prefetch" href="/blog/assets/js/105.af57a03c.js"><link rel="prefetch" href="/blog/assets/js/106.9b2b05b7.js"><link rel="prefetch" href="/blog/assets/js/11.11b5239a.js"><link rel="prefetch" href="/blog/assets/js/12.78c4bd5c.js"><link rel="prefetch" href="/blog/assets/js/13.7e04dbac.js"><link rel="prefetch" href="/blog/assets/js/14.f1c37d77.js"><link rel="prefetch" href="/blog/assets/js/15.381ada5b.js"><link rel="prefetch" href="/blog/assets/js/16.2f224658.js"><link rel="prefetch" href="/blog/assets/js/17.b986808d.js"><link rel="prefetch" href="/blog/assets/js/18.e8082b84.js"><link rel="prefetch" href="/blog/assets/js/19.cdcbca79.js"><link rel="prefetch" href="/blog/assets/js/20.49d13a52.js"><link rel="prefetch" href="/blog/assets/js/21.eea71d2c.js"><link rel="prefetch" href="/blog/assets/js/22.443b74eb.js"><link rel="prefetch" href="/blog/assets/js/23.217fa2a3.js"><link rel="prefetch" href="/blog/assets/js/24.2e0a8dde.js"><link rel="prefetch" href="/blog/assets/js/25.638073bf.js"><link rel="prefetch" href="/blog/assets/js/26.7fd459b0.js"><link rel="prefetch" href="/blog/assets/js/27.d5e2719b.js"><link rel="prefetch" href="/blog/assets/js/28.8de243db.js"><link rel="prefetch" href="/blog/assets/js/29.03dd79b9.js"><link rel="prefetch" href="/blog/assets/js/3.9b0a9344.js"><link rel="prefetch" href="/blog/assets/js/30.7cc2f29c.js"><link rel="prefetch" href="/blog/assets/js/31.c8e05770.js"><link rel="prefetch" href="/blog/assets/js/32.e3ed0638.js"><link rel="prefetch" href="/blog/assets/js/33.7f62de60.js"><link rel="prefetch" href="/blog/assets/js/34.2920d4ce.js"><link rel="prefetch" href="/blog/assets/js/35.3217610a.js"><link rel="prefetch" href="/blog/assets/js/36.2aeb8a98.js"><link rel="prefetch" href="/blog/assets/js/37.c2d48e8b.js"><link rel="prefetch" href="/blog/assets/js/38.3a196bcd.js"><link rel="prefetch" href="/blog/assets/js/39.a16dc39b.js"><link rel="prefetch" href="/blog/assets/js/4.56fda3ff.js"><link rel="prefetch" href="/blog/assets/js/40.861d7708.js"><link rel="prefetch" href="/blog/assets/js/41.acc3ac5a.js"><link rel="prefetch" href="/blog/assets/js/42.1ea1620e.js"><link rel="prefetch" href="/blog/assets/js/43.64da8ae0.js"><link rel="prefetch" href="/blog/assets/js/44.b8ead1b6.js"><link rel="prefetch" href="/blog/assets/js/45.49aec897.js"><link rel="prefetch" href="/blog/assets/js/46.e4314a29.js"><link rel="prefetch" href="/blog/assets/js/47.4d4d35a8.js"><link rel="prefetch" href="/blog/assets/js/48.256d0fe5.js"><link rel="prefetch" href="/blog/assets/js/49.d473ef6c.js"><link rel="prefetch" href="/blog/assets/js/5.7d16fc96.js"><link rel="prefetch" href="/blog/assets/js/50.a9d07f38.js"><link rel="prefetch" href="/blog/assets/js/51.029f32a5.js"><link rel="prefetch" href="/blog/assets/js/52.1aab8b27.js"><link rel="prefetch" href="/blog/assets/js/53.313829e2.js"><link rel="prefetch" href="/blog/assets/js/54.ed2e5fb9.js"><link rel="prefetch" href="/blog/assets/js/55.79e1fffb.js"><link rel="prefetch" href="/blog/assets/js/56.bbf46cec.js"><link rel="prefetch" href="/blog/assets/js/57.f300e220.js"><link rel="prefetch" href="/blog/assets/js/58.97b69c31.js"><link rel="prefetch" href="/blog/assets/js/59.d6024b8c.js"><link rel="prefetch" href="/blog/assets/js/6.c1bd8a18.js"><link rel="prefetch" href="/blog/assets/js/60.be5302a2.js"><link rel="prefetch" href="/blog/assets/js/61.6f8b72d5.js"><link rel="prefetch" href="/blog/assets/js/62.25bb1f2f.js"><link rel="prefetch" href="/blog/assets/js/63.11bbead4.js"><link rel="prefetch" href="/blog/assets/js/65.ceff8f20.js"><link rel="prefetch" href="/blog/assets/js/66.f412204c.js"><link rel="prefetch" href="/blog/assets/js/67.4f0efea9.js"><link rel="prefetch" href="/blog/assets/js/68.2cc1dbdc.js"><link rel="prefetch" href="/blog/assets/js/69.34f63870.js"><link rel="prefetch" href="/blog/assets/js/7.8d45ee92.js"><link rel="prefetch" href="/blog/assets/js/70.781e30ca.js"><link rel="prefetch" href="/blog/assets/js/71.6b60c243.js"><link rel="prefetch" href="/blog/assets/js/72.26e73b48.js"><link rel="prefetch" href="/blog/assets/js/73.65859619.js"><link rel="prefetch" href="/blog/assets/js/74.3dc29fdf.js"><link rel="prefetch" href="/blog/assets/js/75.ea01a128.js"><link rel="prefetch" href="/blog/assets/js/76.3dcee114.js"><link rel="prefetch" href="/blog/assets/js/77.eec105fc.js"><link rel="prefetch" href="/blog/assets/js/78.abe8fe18.js"><link rel="prefetch" href="/blog/assets/js/79.e5372837.js"><link rel="prefetch" href="/blog/assets/js/8.331c43be.js"><link rel="prefetch" href="/blog/assets/js/80.64ab8c8d.js"><link rel="prefetch" href="/blog/assets/js/81.8042faa7.js"><link rel="prefetch" href="/blog/assets/js/82.85015196.js"><link rel="prefetch" href="/blog/assets/js/83.71f7e96c.js"><link rel="prefetch" href="/blog/assets/js/84.8a840b15.js"><link rel="prefetch" href="/blog/assets/js/85.5ea54498.js"><link rel="prefetch" href="/blog/assets/js/86.1e7e47a4.js"><link rel="prefetch" href="/blog/assets/js/87.7b0e6738.js"><link rel="prefetch" href="/blog/assets/js/88.c7b8bf58.js"><link rel="prefetch" href="/blog/assets/js/89.2c4cf96d.js"><link rel="prefetch" href="/blog/assets/js/9.2abb65f2.js"><link rel="prefetch" href="/blog/assets/js/90.b9cf7dd5.js"><link rel="prefetch" href="/blog/assets/js/91.62fb9f73.js"><link rel="prefetch" href="/blog/assets/js/92.50ffa024.js"><link rel="prefetch" href="/blog/assets/js/93.3b14e08c.js"><link rel="prefetch" href="/blog/assets/js/94.bbfbab6d.js"><link rel="prefetch" href="/blog/assets/js/95.40b3d1b0.js"><link rel="prefetch" href="/blog/assets/js/96.4f8751cf.js"><link rel="prefetch" href="/blog/assets/js/97.05a0194a.js"><link rel="prefetch" href="/blog/assets/js/98.96a3043f.js"><link rel="prefetch" href="/blog/assets/js/99.fed91772.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.069fd700.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">技术小站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java篇" class="dropdown-title"><span class="title">Java篇</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java篇" class="mobile-dropdown-title"><span class="title">Java篇</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/collection/" class="nav-link">
  Java 容器
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/jvm/" class="nav-link">
  Java 虚拟机
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/concurrent/" class="nav-link router-link-active">
  Java 高并发
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/io/" class="nav-link">
  Java IO
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/database/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/blog/database/redis/" class="nav-link">
  redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架篇" class="dropdown-title"><span class="title">框架篇</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架篇" class="mobile-dropdown-title"><span class="title">框架篇</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frame/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/blog/frame/springboot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/blog/frame/mybatis/" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶篇" class="dropdown-title"><span class="title">进阶篇</span> <span class="arrow down"></span></button> <button type="button" aria-label="进阶篇" class="mobile-dropdown-title"><span class="title">进阶篇</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/middleware/es/" class="nav-link">
  Elasticsearch
</a></li><li class="dropdown-item"><!----> <a href="/blog/middleware/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/blog/middleware/k8s/" class="nav-link">
  Kubernetes
</a></li></ul></div></div><div class="nav-item"><a href="/blog/design/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/blog/util/" class="nav-link">
  工具向
</a></div><div class="nav-item"><a href="/blog/personal/" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java篇" class="dropdown-title"><span class="title">Java篇</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java篇" class="mobile-dropdown-title"><span class="title">Java篇</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/java/collection/" class="nav-link">
  Java 容器
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/jvm/" class="nav-link">
  Java 虚拟机
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/concurrent/" class="nav-link router-link-active">
  Java 高并发
</a></li><li class="dropdown-item"><!----> <a href="/blog/java/io/" class="nav-link">
  Java IO
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/database/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/blog/database/redis/" class="nav-link">
  redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架篇" class="dropdown-title"><span class="title">框架篇</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架篇" class="mobile-dropdown-title"><span class="title">框架篇</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frame/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/blog/frame/springboot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/blog/frame/mybatis/" class="nav-link">
  MyBatis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶篇" class="dropdown-title"><span class="title">进阶篇</span> <span class="arrow down"></span></button> <button type="button" aria-label="进阶篇" class="mobile-dropdown-title"><span class="title">进阶篇</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/middleware/es/" class="nav-link">
  Elasticsearch
</a></li><li class="dropdown-item"><!----> <a href="/blog/middleware/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/blog/middleware/k8s/" class="nav-link">
  Kubernetes
</a></li></ul></div></div><div class="nav-item"><a href="/blog/design/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/blog/util/" class="nav-link">
  工具向
</a></div><div class="nav-item"><a href="/blog/personal/" class="nav-link">
  关于我
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java工程师成长计划</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>重点总结</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/java/concurrent/single/线程的生命周期.html" class="sidebar-link">线程的生命周期</a></li><li><a href="/blog/java/concurrent/single/线程池的执行流程.html" class="sidebar-link">线程池的执行</a></li><li><a href="/blog/java/concurrent/single/线程池的关闭.html" class="sidebar-link">线程池的关闭</a></li><li><a href="/blog/java/concurrent/single/BlockQueue阻塞队列.html" class="sidebar-link">阻塞队列BlockQueue</a></li><li><a href="/blog/java/concurrent/single/ThreadLocal.html" aria-current="page" class="active sidebar-link">ThreadLocal总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/java/concurrent/single/CAS.html" class="sidebar-link">CAS总结</a></li><li><a href="/blog/java/concurrent/single/原子类.html" class="sidebar-link">原子类</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="threadlocal总结"><a href="#threadlocal总结" class="header-anchor">#</a> ThreadLocal总结</h3> <ul><li><a href="#%E6%A6%82%E5%BF%B5">概念</a></li> <li><a href="#%E7%AE%80%E5%8D%95%E4%BE%8B%E5%AD%90">简单例子</a></li> <li><a href="#%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB">源码阅读</a></li> <li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E5%BC%B1%E5%BC%95%E7%94%A8">为什么使用弱引用</a></li> <li><a href="#%E6%80%8E%E6%A0%B7%E9%98%B2%E6%AD%A2%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F">怎样防止内存泄漏</a></li> <li><a href="#%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98">相关问题</a></li> <li><a href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">参考链接</a></li></ul> <h4 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h4> <p>ThreadLocal 提供了线程的局部变量，只有当前线程可以操作，不会和其它线程的局部变量产生冲突，实现了变量的线程安全。<code>ThreadLocal&lt;T&gt;</code> 位于 <code>java.lang</code> 包下，可以封装各种类型的变量。ThradLocal 是除了实现同步以外的一种保证多线程变量访问的线程安全的方式。</p> <h4 id="简单例子"><a href="#简单例子" class="header-anchor">#</a> 简单例子</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//主线程</span>
        threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token comment">//新线程</span>
            threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
<span class="token punctuation">}</span>

<span class="token comment">//output</span>
<span class="token comment">//main</span>
<span class="token comment">//thread</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>从代码中可以看到，新线程和主线程之间对  ThreadLocal 的修改不会互相影响。</p> <p>对例子的内存图分析如下，可以看到两个线程其实指向的是同一个 ThreadLocal  对象，而每个线程都会在内存中维护一个 ThreadLocalMap ，需要注意 ThreadLocalMap 存放的 key 是 ThreadLocal 对象的弱引用，value 存放的是设置的值。(具体可见源码阅读)</p> <p><img src="https://cdn.jsdelivr.net/gh/AlbertYang0801/pic-bed@main/img/20210508141039.png" alt=""></p> <h4 id="源码阅读"><a href="#源码阅读" class="header-anchor">#</a> 源码阅读</h4> <p>ThreadLocal 内部维护了一个静态类 ThreadLocalMap , ThreadLocalMap  内部维护了一个 Entry  类用来存储数据。 key 值存放的就是 ThreadLocal 对象，而 value 存放的就是 ThreadLocal 里需要存放的变量。</p> <ul><li><p>set方法</p> <p>将数据添加到 ThreadLocalMap 中，  key 是 ThreadLocal 对象 ，而 value 是需要设置的 ThreadLocal 里需要存放的变量。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  
    <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> threadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  
  	<span class="token comment">//set方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取当前线程</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取当前线程拥有的局部变量map，对应threadLocals</span>
        <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">//将ThreadLocal作为key，传入value保存到map中</span>
            map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token comment">//若map为空，新建一个</span>
            <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">void</span> <span class="token function">createMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">T</span> firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">//调用ThreadLocalMap的构造方法</span>
        t<span class="token punctuation">.</span>threadLocals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalMap</span> <span class="token punctuation">{</span>
      
      			<span class="token keyword">private</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>

         		<span class="token comment">//ThreadLocalMap内存封装的Entry用于保存数据（弱引用）</span>
            <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadLocal</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
                <span class="token comment">/** The value associated with this ThreadLocal. */</span>
                <span class="token class-name">Object</span> value<span class="token punctuation">;</span>
								
              	<span class="token comment">//key值是ThreadLocal</span>
                <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k<span class="token punctuation">,</span> <span class="token class-name">Object</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    value <span class="token operator">=</span> v<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
      
            <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> firstKey<span class="token punctuation">,</span> <span class="token class-name">Object</span> firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              	<span class="token comment">//初始化数组</span>
                table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>INITIAL_CAPACITY<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> i <span class="token operator">=</span> firstKey<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>INITIAL_CAPACITY <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              	<span class="token comment">//保存ThreadLocal对象</span>
                table<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>firstKey<span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token function">setThreshold</span><span class="token punctuation">(</span>INITIAL_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        		<span class="token punctuation">}</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

     <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div></li> <li><p>get方法</p> <p>首先根据当前线程获取对应的 ThreadLocalMap 实例，该实例存放了对应的变量值，其中 key 是 ThreadLocal 对象。根据 ThreadLocal  对象从 ThreadLocalMap  中获取 ThreadLocal 对应的 Entry ，返回Entry 里的 value 值，即为 ThreadLocal 对应的变量值。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  
  	<span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> threadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取当前线程</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//获取当前线程维护的ThreadLocalMap</span>
        <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">//根据ThreadLocal对象（key）从ThreadLocalMap获取对应存放的实体类</span>
            <span class="token class-name">ThreadLocalMap<span class="token punctuation">.</span>Entry</span> e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
              	<span class="token comment">//从Entry获取value值</span>
                <span class="token class-name">T</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  	<span class="token comment">//根据线程获取ThreadLocalMap</span>
    <span class="token class-name">ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalMap</span> <span class="token punctuation">{</span>
      
      			<span class="token keyword">private</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>

         		<span class="token comment">//ThreadLocalMap内存封装的Entry用于保存数据（弱引用）</span>
            <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadLocal</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
                <span class="token comment">/** The value associated with this ThreadLocal. */</span>
                <span class="token class-name">Object</span> value<span class="token punctuation">;</span>
								
              	<span class="token comment">//key值是ThreadLocal</span>
                <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k<span class="token punctuation">,</span> <span class="token class-name">Object</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    value <span class="token operator">=</span> v<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
      
      			<span class="token comment">//根据ThreadLocal获取对应Entry</span>
            <span class="token keyword">private</span> <span class="token class-name">Entry</span> <span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            		<span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>table<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Entry</span> e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> key<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> e<span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    <span class="token keyword">return</span> <span class="token function">getEntryAfterMiss</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        		<span class="token punctuation">}</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

     <span class="token punctuation">}</span>
  
  
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div></li></ul> <h4 id="为什么使用弱引用"><a href="#为什么使用弱引用" class="header-anchor">#</a> 为什么使用弱引用</h4> <blockquote><p>弱引用：如果一个对象仅被一个弱引用指向，那么在下一次内存回收的时候，这个对象就会被垃圾回收器回收掉。</p></blockquote> <p>实际保存  ThreadLocal 变量值的是 Entry 类，该类是 ThreadLocal  内部类 ThreadLocalMap 里的内部类。通过源码可以看到  key 的赋值使用了弱引用。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadLocal</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
            <span class="token comment">/** The value associated with this ThreadLocal. */</span>
            <span class="token class-name">Object</span> value<span class="token punctuation">;</span>

            <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k<span class="token punctuation">,</span> <span class="token class-name">Object</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              	<span class="token comment">//调用父类的方法</span>
                <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                value <span class="token operator">=</span> v<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>继续分析上方的例子，如果我们在使用 ThreadLocal  结束之后，将线程中的 ThreadLocal引用 指向 <code>null</code>，即释放 ThreadLocal 对象。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ThreadLocalDemo</span><span class="token punctuation">.</span>threadLocal <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>假设 ThreadLocalMap 的 key 对应的引用是 <code>强引用</code>。</li></ul> <blockquote><p>强引用：指创建一个对象并把这个对象赋给一个引用变量， 强引用有引用变量指向时永远不会被垃圾回收。即使内存不足的时候宁愿报OOM也不被垃圾回收器回收，我们new的对象都是强引用</p></blockquote> <p>此时如图所示，虽然线程不会拥有对  ThreadLocal  对象的引用，但是线程内部的 ThreadLocalMap 会一直持有对  ThreadLocal 的引用，而这个时候 ThreadLocal  就无法被真正释放，占用着内存直到线程结束。由于  ThreadLocal 没有被线程引用而且占据着内存，就造成了 <code>内存泄漏</code> 的问题。</p> <p><img src="https://cdn.jsdelivr.net/gh/AlbertYang0801/pic-bed@main/img/20210508141057.png" alt=""></p> <ul><li>而如果 ThreadLocalMap 的 key 对应的引用是 <code>弱引用</code>，根据 <code>弱引用</code> 的定义，如果一个对象仅被一个弱引用指向，那么在下一次内存回收的时候，这个对象就会被垃圾回收器回收掉。所以当设置 ThreadLocal  为 <code>null</code> 之后，线程对象不再指向 ThreadLocal 对象 ，此时指向 ThreadLocal 对象的只有 ThreadLocalMap 里的 key  对它的弱引用，这样 ThreadLocal  就会在下一次内存回收的时候被回收掉，进而避免了 <code>内存泄漏</code> 的发生。</li></ul> <p><strong>总结</strong></p> <p>使用 <code>弱引用</code> 的作用是为了防止 ThreadLocal 对象无法回收造成的 <code>内存泄漏</code>。</p> <h4 id="怎样防止内存泄漏"><a href="#怎样防止内存泄漏" class="header-anchor">#</a> 怎样防止内存泄漏</h4> <p>有了<code>弱引用</code> 的加入之后，虽然可以避免 ThreadLocal  对象无法回收造成的 <code>内存泄漏</code>，但此时使用 ThreadLocal 还是会存在 <code>内存泄漏</code> 的问题。</p> <p><strong>原因分析</strong></p> <p>当 key 值的 ThreadLocal 对象为 <code>null</code> 时，因为 <code>弱引用</code> 的原因，ThreadLocal 对象会被内存回收。但此时 ThreadLocalMap 里对应的 value 值的引用还存在，由于 key 已被回收，所以 value 无法被访问并占据内存，进而产生了 <code>内存泄漏</code>。</p> <p><strong>解决办法</strong></p> <p>ThreadLocal 提供了 <code>remove()</code> 方法，可以将 ThreadLocalMap 里对应的 <code>key</code> 和 <code>value</code> 都清空掉。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       	 <span class="token comment">//获取当前线程的ThreadLocalMap</span>
         <span class="token class-name">ThreadLocalMap</span> m <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
           	 <span class="token comment">//根据ThreadLocal对象从ThreadLocalMap清除</span>
             m<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>总结</strong></p> <p>每次在操作完 ThreadLocal  之后，在适当的位置调用 <code>remove()</code> 方法。</p> <h4 id="相关问题"><a href="#相关问题" class="header-anchor">#</a> 相关问题</h4> <ol><li><p>线程池使用 Threadlocal 的问题？</p> <p>线程池中的线程是可以复用的，假如第一个线程对  ThreadLocal 变量进行了操作，如果没有及时清理，下一个线程就会受到影响。因为 ThreadLocal  是在每个线程上维护了一个 ThreadLocalMap ，所以在线程复用的情况下，之后的线程会获取到  ThreadLocal  里之前线程设置的值。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>		<span class="token comment">//对ThreadLocal设置初始值0</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> threadLocal <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Integer</span> before <span class="token operator">=</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              	<span class="token comment">//初始值+1</span>
                threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Integer</span> after <span class="token operator">=</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;before :&quot;</span> <span class="token operator">+</span> before <span class="token operator">+</span> <span class="token string">&quot;，after：&quot;</span> <span class="token operator">+</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token comment">//output</span>
<span class="token comment">//before :0，after：1</span>
<span class="token comment">//before :0，after：1</span>
<span class="token comment">//before :1，after：2</span>
<span class="token comment">//before :1，after：2</span>
<span class="token comment">//before :2，after：3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>由于不对  ThreadLocal  进行及时清理，对后面线程会产生影响。所以在当前线程使用完 ThreadLocal 之后，应及时清理。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>		<span class="token comment">//对ThreadLocal设置初始值0</span>
		<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> threadLocal <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Integer</span> before <span class="token operator">=</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Integer</span> after <span class="token operator">=</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;before :&quot;</span> <span class="token operator">+</span> before <span class="token operator">+</span> <span class="token string">&quot;，after：&quot;</span> <span class="token operator">+</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">//当前线程使用完及时回收</span>
                    threadLocal<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token comment">//output</span>
<span class="token comment">//before :0，after：1</span>
<span class="token comment">//before :0，after：1</span>
<span class="token comment">//before :0，after：1</span>
<span class="token comment">//before :0，after：1</span>
<span class="token comment">//before :0，after：1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div></li> <li><p>为什么 ThreadLocal 内部使用弱引用可以防止内存泄露？</p> <p><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E5%BC%B1%E5%BC%95%E7%94%A8">为什么使用弱引用</a></p></li></ol> <h4 id="参考链接"><a href="#参考链接" class="header-anchor">#</a> 参考链接</h4> <p><a href="https://juejin.cn/post/6932762461414096904" target="_blank" rel="noopener noreferrer">掘金：ThreadLocal与弱引用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.cnblogs.com/westlin/p/10645217.html" target="_blank" rel="noopener noreferrer">ThreadLocal与线程池使用的问题<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021-10-08 18:02:20</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/java/concurrent/single/BlockQueue阻塞队列.html" class="prev">
        阻塞队列BlockQueue
      </a></span> <span class="next"><a href="/blog/java/concurrent/single/CAS.html">
        CAS总结
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.20191c45.js" defer></script><script src="/blog/assets/js/2.7ded94f8.js" defer></script><script src="/blog/assets/js/64.00e9edf7.js" defer></script>
  </body>
</html>
