import{_ as a,c as n,o as i,aN as l}from"./chunks/framework.A-MC8nKA.js";const o=JSON.parse('{"title":"ES压测记录和esrally使用","description":"","frontmatter":{},"headers":[],"relativePath":"middleware/es/ES压测记录和esrally使用.md","filePath":"middleware/es/ES压测记录和esrally使用.md","lastUpdated":1752827238000}'),e={name:"middleware/es/ES压测记录和esrally使用.md"};function p(t,s,r,h,c,d){return i(),n("div",null,s[0]||(s[0]=[l(`<h1 id="es压测记录和esrally使用" tabindex="-1">ES压测记录和esrally使用 <a class="header-anchor" href="#es压测记录和esrally使用" aria-label="Permalink to &quot;ES压测记录和esrally使用&quot;">​</a></h1><h2 id="环境信息" tabindex="-1">环境信息 <a class="header-anchor" href="#环境信息" aria-label="Permalink to &quot;环境信息&quot;">​</a></h2><ul><li><p>压测环境</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>http://10.1.11.200:39200/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>开发环境</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//10.10.101.69:39200</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>测试环境</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//10.10.103.218:39200/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ul><h2 id="esrally安装" tabindex="-1">esrally安装 <a class="header-anchor" href="#esrally安装" aria-label="Permalink to &quot;esrally安装&quot;">​</a></h2><h3 id="docker安装" tabindex="-1">docker安装 <a class="header-anchor" href="#docker安装" aria-label="Permalink to &quot;docker安装&quot;">​</a></h3><ol><li><p>拉取镜像</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>docker pull elastic/rally</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>查看 track 列表</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>docker run elastic/rally list tracks</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>运行 rally镜像</p><ul><li>root 用户启动：<code>u root</code></li><li>挂载本地磁盘：<code>v /home/rally:/tracks</code></li></ul><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>docker run -it -u root -v  /home/rally:/tracks elastic/rally /bin/bash</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>根据已有 es 索引创建 track</p><ul><li><code>-track=httpdata</code>：track 名称</li><li><code>-target-hosts</code>：es 地址</li><li><code>-indices</code>：指定索引名称，多个以逗号隔开</li><li><code>-output-path</code>：track 挂在目录</li><li><code>-client-options</code>：es 验证信息（可选）</li></ul><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>esrally create-track --track=httpdata --target-hosts=10.1.10.176:9200 --indices=&quot;bpm1.0-shiya_test-httpdata-1&quot; --output-path=/tracks --client-options=&quot;use_ssl:false,basic_auth_user:&#39;elastic&#39;,basic_auth_password:&#39;elastic&#39;&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><blockquote><p>根据已有索引生成的 track，json 文件保留了索引的全部数据。</p></blockquote><p><img src="https://s2.loli.net/2025/06/26/OPLqC2hRxYEsjMd.png" alt="20220210201727.png" loading="lazy"></p></li></ol><h3 id="k8s安装" tabindex="-1">k8s安装 <a class="header-anchor" href="#k8s安装" aria-label="Permalink to &quot;k8s安装&quot;">​</a></h3><p>由于 es 使用 k8s 部署，所以将 esrally 部署到 k8s 同一个 namespace 下。</p><p><strong>esrally-pod.yaml</strong></p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Pod</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">esrally</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cloudmonitor</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">rally</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  restartPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Always</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  node-selector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10.1.11.200-master</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  containers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">rally</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">elastic/rally:latest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    imagePullPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Always</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">tail</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">-f</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/dev/null</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #容器内部挂载路径</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    volumeMounts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">rally-data</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      mountPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/tracks</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #本地挂载路径</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;"> volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">rally-data</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    hostPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/home/rally</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="rally命令" tabindex="-1">rally命令 <a class="header-anchor" href="#rally命令" aria-label="Permalink to &quot;rally命令&quot;">​</a></h2><ol><li><p>查看指定目录下的 track</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>esrally list tracks --track-path=/tracks/httpdata</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>启动 race，自定义 track。</p><ul><li>自定义 track，需要使用 <code>-track-path</code> 指定路径。</li><li>官方自带的 track，使用 <code>-track</code> 即可。</li><li>指定 <code>-test-mode</code>, 标识进行测试，只插入1000条数据。不指定则选择全量插入。</li></ul><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>esrally race --track-path=/tracks/httpdata --test-mode --pipeline=benchmark-only --target-hosts=10.1.10.176:9200 --client-options=&quot;use_ssl:false,basic_auth_user:&#39;elastic&#39;,basic_auth_password:&#39;elastic&#39;&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><blockquote><p>同时只能有一个trace，若想强制关闭正在运行的trace，可以在启动新的trace时，添加参数：--kill-running-processes</p></blockquote></li></ol><h2 id="track-json配置" tabindex="-1">track.json配置 <a class="header-anchor" href="#track-json配置" aria-label="Permalink to &quot;track.json配置&quot;">​</a></h2><p><img src="https://s2.loli.net/2025/06/26/DJzW146YKSMnFTx.png" alt="20220210202349.png" loading="lazy"></p><p>优化track.json</p><ul><li><p>新增 mapping 的类型。</p><p><img src="https://s2.loli.net/2025/06/26/MGRH3AxETcYk2BS.png" alt="20220214174513.png" loading="lazy"></p></li><li><p>删除多余的 operation。</p><p><img src="https://s2.loli.net/2025/06/26/6Z9GRzkYn8TciI5.png" alt="20220214174533.png" loading="lazy"></p></li></ul><h2 id="测试方案" tabindex="-1">测试方案 <a class="header-anchor" href="#测试方案" aria-label="Permalink to &quot;测试方案&quot;">​</a></h2><ol><li>在固定集群节点数和资源情况下，调整插入的文档数据量，测试不同数据量文档对插入的影响。</li><li>固定插入文档数据量和集群节点数量，调整节点资源限制，测试不同节点资源下对插入的影响。</li><li>固定插入文档数据量和节点资源限制，调整集群节点数量，测试不同节点数量下对插入的影响。</li></ol><h2 id="测试命令" tabindex="-1">测试命令 <a class="header-anchor" href="#测试命令" aria-label="Permalink to &quot;测试命令&quot;">​</a></h2><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span></span></span>
<span class="line"><span>创建不同的索引</span></span>
<span class="line"><span></span></span>
<span class="line"><span>esrally create-track --track=aggentity --target-hosts=10.1.11.200:39200  --indices=&quot;apm2.0-yanshi_default_default-npm_agg_entity-2022.02.11&quot; --output-path=/tracks</span></span>
<span class="line"><span></span></span>
<span class="line"><span>esrally race --track-path=/tracks/aggentity --pipeline=benchmark-only --target-hosts=10.1.11.200:39200 </span></span>
<span class="line"><span></span></span>
<span class="line"><span>esrally create-track --track=aggtopo --target-hosts=10.1.11.200:39200  --indices=&quot;apm2.0-yanshi_default_default-npm_agg_topology-2022.02.11&quot; --output-path=/tracks</span></span>
<span class="line"><span></span></span>
<span class="line"><span>esrally race --track-path=/tracks/aggtopo --pipeline=benchmark-only --target-hosts=10.1.11.200:39200 </span></span>
<span class="line"><span></span></span>
<span class="line"><span>esrally create-track --track=detailentity --target-hosts=10.1.11.200:39200  --indices=&quot;apm2.0-yanshi_default_default-npm_detail_entity-2022.02.11&quot; --output-path=/tracks</span></span>
<span class="line"><span></span></span>
<span class="line"><span>http://10.10.103.218:39200/</span></span>
<span class="line"><span></span></span>
<span class="line"><span>esrally create-track --track=npmtopo --target-hosts=10.1.11.200:39200 --indices=&quot;apm2.0-yanshi_default_default-npm_detail_topology-2022.02.11</span></span>
<span class="line"><span>&quot; --output-path=/tracks</span></span>
<span class="line"><span></span></span>
<span class="line"><span>esrally race --track-path=/tracks/npmtopo --test-mode --pipeline=benchmark-only --target-hosts=10.1.11.200:39200 </span></span>
<span class="line"><span></span></span>
<span class="line"><span>esrally race --track-path=/tracks/npmtopo --pipeline=benchmark-only --target-hosts=10.1.11.200:39200 </span></span>
<span class="line"><span></span></span>
<span class="line"><span>#进入容器</span></span>
<span class="line"><span></span></span>
<span class="line"><span>docker exec -it -u root a078cb866b23 /bin/bash</span></span>
<span class="line"><span></span></span>
<span class="line"><span>apm2.0-yanshi_default_default-npm_request_trace-2022.02.11</span></span>
<span class="line"><span></span></span>
<span class="line"><span>esrally race --track-path=/tracks/npmtrace --pipeline=benchmark-only --target-hosts=10.1.11.200:39200 </span></span>
<span class="line"><span></span></span>
<span class="line"><span> kubectl get statefulset.apps/es-cluster  -n cloudmonitor -o yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>kubectl edit statefulset.apps/es-cluster  -n cloudmonitor </span></span>
<span class="line"><span></span></span>
<span class="line"><span>esrally race --track-path=/tracks/detailentity --pipeline=benchmark-only --target-hosts=10.1.11.200:39200</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h2 id="参考链接" tabindex="-1">参考链接 <a class="header-anchor" href="#参考链接" aria-label="Permalink to &quot;参考链接&quot;">​</a></h2><ul><li><a href="https://esrally.readthedocs.io/en/2.3.1/docker.html" target="_blank" rel="noreferrer">官网-使用 Docker 运行 Rally</a></li><li><a href="http://esrally.lyremelody.org/zh_CN/latest/glossary.html" target="_blank" rel="noreferrer">Rally-术语表</a></li></ul>`,22)]))}const u=a(e,[["render",p]]);export{o as __pageData,u as default};
