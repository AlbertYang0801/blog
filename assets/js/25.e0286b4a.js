(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{336:function(s,a,t){"use strict";t.r(a);var e=t(18),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mysql基础架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql基础架构"}},[s._v("#")]),s._v(" MySQL基础架构")]),s._v(" "),a("p",[s._v("MySQL是 "),a("code",[s._v("C/S（Client端 / Server端）")]),s._v(" 架构。")]),s._v(" "),a("h2",{attrs:{id:"架构图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#架构图"}},[s._v("#")]),s._v(" 架构图")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.loli.net/2025/06/13/xLeckiQH49lnEum.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://s2.loli.net/2025/06/13/vGxZt3HAJRpXsnS.png",alt:""}})]),s._v(" "),a("p",[s._v("MySQL架构包含 "),a("code",[s._v("Server层")]),s._v(" 和 "),a("code",[s._v("存储引擎层")]),s._v(" 。")]),s._v(" "),a("ul",[a("li",[s._v("Server 层包含 "),a("code",[s._v("连接器")]),s._v(" 、"),a("code",[s._v("分析器")]),s._v("、"),a("code",[s._v("优化器")]),s._v("、"),a("code",[s._v("执行器")]),s._v("。")]),s._v(" "),a("li",[s._v("存储引擎层包含 "),a("code",[s._v("引擎层")]),s._v("、"),a("code",[s._v("存储层")]),s._v("。")])]),s._v(" "),a("h2",{attrs:{id:"一、连接器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、连接器"}},[s._v("#")]),s._v(" 一、连接器")]),s._v(" "),a("h3",{attrs:{id:"连接器的作用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#连接器的作用"}},[s._v("#")]),s._v(" 连接器的作用")]),s._v(" "),a("ul",[a("li",[s._v("跟客户端建立连接。")]),s._v(" "),a("li",[s._v("维持和管理连接。")]),s._v(" "),a("li",[a("strong",[s._v("校验用户和获取用户权限")]),s._v("。")])]),s._v(" "),a("hr"),s._v(" "),a("h3",{attrs:{id:"校验用户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#校验用户"}},[s._v("#")]),s._v(" 校验用户")]),s._v(" "),a("p",[s._v("客户端进行连接MySQL的命令如下：")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[s._v("mysql "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("h$ip "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("P")]),s._v("$port "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("u$user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在网络连接 TCP 握手成功之后，连接器会校验用户名和密码。")]),s._v(" "),a("ul",[a("li",[s._v("如果用户名或者密码错误，会直接返回错误提示"),a("code",[s._v("Access denied for user")]),s._v("。")])]),s._v(" "),a("h3",{attrs:{id:"获取用户权限"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#获取用户权限"}},[s._v("#")]),s._v(" 获取用户权限")]),s._v(" "),a("p",[s._v("用户名密码认证通过后，连接器会到权限表查询用户拥有的权限，并赋予对应操作权限。")]),s._v(" "),a("blockquote",[a("p",[s._v("假如连接成功后修改用户权限，也不会影响已经建立连接过的用户。只有断开当前连接重新连接，权限才会生效。")])]),s._v(" "),a("h3",{attrs:{id:"数据库连接池"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库连接池"}},[s._v("#")]),s._v(" 数据库连接池")]),s._v(" "),a("p",[s._v("客户端与数据库建立连接的过程是比较复杂的，流程如下：")]),s._v(" "),a("ol",[a("li",[s._v("TCP建立连接的三次握手。")]),s._v(" "),a("li",[s._v("MySQL认证的认证校验。")]),s._v(" "),a("li",[s._v("真正的SQL执行。")]),s._v(" "),a("li",[s._v("MySQL的关闭。")]),s._v(" "),a("li",[s._v("TCP的四次挥手关闭连接。")])]),s._v(" "),a("blockquote",[a("p",[s._v("数据库连接池能够维护一定的数据库长连接，方便客户端复用，当客户端需要连接数据库时，从连接池获取连接，用完归还即可。无需关心数据库连接池是如何管理这些连接的。")])]),s._v(" "),a("p",[s._v("在使用连接池后，除了首次需要进行 MySQL连接的初始化，后续使用只需要关注 执行SQL 这部分的开销。")]),s._v(" "),a("p",[s._v("常见的数据库连接池有：")]),s._v(" "),a("ul",[a("li",[s._v("Druid")]),s._v(" "),a("li",[s._v("C3p0")])]),s._v(" "),a("hr"),s._v(" "),a("h3",{attrs:{id:"池化思想"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#池化思想"}},[s._v("#")]),s._v(" 池化思想")]),s._v(" "),a("p",[s._v("一般是对象的池化。核心思想是"),a("code",[s._v("空间换时间")]),s._v("。")]),s._v(" "),a("p",[s._v("使用预先创建好的对象来减少频繁创建对象的损失，重复利用对象，同时还能够对对象统一管理。")]),s._v(" "),a("p",[s._v("比如："),a("code",[s._v("线程池")]),s._v("、"),a("code",[s._v("数据库连接池")]),s._v("、"),a("code",[s._v("字符串常量池")]),s._v("。")]),s._v(" "),a("h3",{attrs:{id:"sql接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sql接口"}},[s._v("#")]),s._v(" SQL接口")]),s._v(" "),a("p",[s._v("SQL语句的入口，接受用户的SQL命令，支持接受 DMS，DDL语句，还支持视图、存储过程，并将最终结果返回给用户。")]),s._v(" "),a("h2",{attrs:{id:"二、查询缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、查询缓存"}},[s._v("#")]),s._v(" 二、查询缓存")]),s._v(" "),a("p",[s._v("在连接器建立连接之后，通过SQL接口接入的SQL语句，若执行的是 "),a("code",[s._v("select")]),s._v(" 语句，则连接器会先查询缓存。")]),s._v(" "),a("ul",[a("li",[s._v("查询缓存命中的话，会 "),a("strong",[s._v("判断用户是否有操作表的权限")]),s._v("，符合权限会直接返回结果。")]),s._v(" "),a("li",[s._v("查询未命中，会继续后面的执行阶段。")])]),s._v(" "),a("h3",{attrs:{id:"缓存的原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缓存的原理"}},[s._v("#")]),s._v(" 缓存的原理")]),s._v(" "),a("p",[s._v("之前查询的结果会以 K-V 结构存储在缓存中，其中 K 为执行的SQL，V为查询的结果。")]),s._v(" "),a("p",[s._v("当数据表记录更新删除的时候，要同步修改缓存中的数据。")]),s._v(" "),a("h3",{attrs:{id:"查询缓存的弊端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询缓存的弊端"}},[s._v("#")]),s._v(" 查询缓存的弊端")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("查询缓存的 K 需要保证 SQL语句保持一致才会利用到缓存，这也导致查询缓存的场景有局限性。")])]),s._v(" "),a("li",[a("p",[s._v("若更新删除频繁，查询缓存的利用率会更低。")]),s._v(" "),a("p",[s._v("因为更新删除数据表后，该表在缓存中的记录要被全部删除。可能存在数据存入缓存还未利用，便被更新操作删除了。")])])]),s._v(" "),a("blockquote",[a("p",[s._v("查询缓存适用于不会频繁变动的数据表，比如配置信息表。")])]),s._v(" "),a("h3",{attrs:{id:"手动使用查询缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#手动使用查询缓存"}},[s._v("#")]),s._v(" 手动使用查询缓存")]),s._v(" "),a("p",[s._v("在 "),a("code",[s._v("select")]),s._v(" 语句中，使用关键字 "),a("code",[s._v("SQL_CACHE")]),s._v(" 可以手动指定查询缓存。")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[s._v("select "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SQL_CACHE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" from "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" where id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("MySQL8.0 删除了 "),a("strong",[s._v("查询缓存")]),s._v(" 这部分功能。")]),s._v(" "),a("h2",{attrs:{id:"三、分析器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、分析器"}},[s._v("#")]),s._v(" 三、分析器")]),s._v(" "),a("p",[s._v("分析器会解析传入的 SQL语句，进行语法分析。")]),s._v(" "),a("h3",{attrs:{id:"词法分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#词法分析"}},[s._v("#")]),s._v(" 词法分析")]),s._v(" "),a("p",[s._v("MySQL通过语法分析，能够知道 SQL 语句需要执行的功能。")]),s._v(" "),a("p",[a("code",[s._v("解析 SQL 语句中的关键字")]),s._v("，比如 SELECT 关键字，表名等。")]),s._v(" "),a("h3",{attrs:{id:"语法分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#语法分析"}},[s._v("#")]),s._v(" 语法分析")]),s._v(" "),a("p",[s._v("语法分析的作用是 "),a("code",[s._v("校验 SQL 的合法性")]),s._v("。")]),s._v(" "),a("p",[s._v("若 SQL 语句不满足语法规定，会提示 "),a("strong",[s._v("语法错误")]),s._v("。")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[s._v("mysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" elect "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" from t where "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ERROR")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1064")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("You")]),s._v(" have an error in your "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SQL")]),s._v(" syntax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" check the manual that corresponds "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("your")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MySQL")]),s._v(" server version "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the right syntax "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("use")]),s._v(" near 'elect "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" from t where "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("' at line "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("语法规定包括 "),a("code",[s._v("表名")]),s._v("、"),a("code",[s._v("字段名称")]),s._v("的校验，还有参数等的校验。")]),s._v(" "),a("h2",{attrs:{id:"四、查询优化器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、查询优化器"}},[s._v("#")]),s._v(" 四、查询优化器")]),s._v(" "),a("p",[s._v("SQL 语句在被执行之前，会被查询优化器进行优化。")]),s._v(" "),a("p",[s._v("优化器在以下情况下会被使用：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("操作的表包含多个索引。")]),s._v(" "),a("p",[s._v("优化器会选择合适的索引。")])]),s._v(" "),a("li",[a("p",[s._v("SQL 语句包含连接（JOIN）查询。")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[s._v("select "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" from "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),s._v(" join "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("B")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("using")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" where "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" and "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("B")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("比如先查询 A 表，c=20的记录，再根据 ID 查询 B 表，d=20的记录。假如反过来先查询 B 表，再根据 ID 查询 A 表。")]),s._v(" "),a("p",[s._v("虽然查询结果一致，但是前后效率是不一致的。")]),s._v(" "),a("p",[s._v("优化器会选择先执行哪部分效率会更高。")]),s._v(" "),a("hr")])]),s._v(" "),a("h2",{attrs:{id:"五、执行器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、执行器"}},[s._v("#")]),s._v(" 五、执行器")]),s._v(" "),a("p",[s._v("分析器使 MySQL 知道了 SQL语句要做什么，通过优化器对SQL 进行了优化。")]),s._v(" "),a("p",[s._v("最终需要执行器进行 SQL 执行。")]),s._v(" "),a("hr"),s._v(" "),a("h3",{attrs:{id:"权限校验"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#权限校验"}},[s._v("#")]),s._v(" 权限校验")]),s._v(" "),a("p",[s._v("在执行 SQL 语句之前，执行器会对 SQL 语句中涉及到的表进行 "),a("strong",[s._v("权限校验")]),s._v("。")]),s._v(" "),a("ol",[a("li",[s._v("如果没有操作表的权限，会提示权限不足。")])]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[s._v("mysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" select "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" from "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("T")]),s._v(" where "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ERROR")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1142")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("42000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SELECT")]),s._v(" command denied "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token char"}},[s._v("'b'")]),s._v("@'localhost' "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" table "),a("span",{pre:!0,attrs:{class:"token char"}},[s._v("'T'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",[a("li",[s._v("如果权限校验通过，会进行 SQL 执行。")])]),s._v(" "),a("h3",{attrs:{id:"执行器的执行流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#执行器的执行流程"}},[s._v("#")]),s._v(" 执行器的执行流程")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" Test "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" ID"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("执行器会获取 SQL 语句中的数据表 "),a("code",[s._v("Test")]),s._v(" 定义的引擎（InnoDB），再根据引擎的定义接口执行语句。")]),s._v(" "),a("p",[s._v("比如没有索引的情况，执行流程如下：")]),s._v(" "),a("ol",[a("li",[s._v("调用 InnoDB引擎接口，获取 "),a("code",[s._v("Test")]),s._v("表的第一行，判断 ID = 10。\n"),a("ul",[a("li",[s._v("若不是则跳过，若是则将结果存到结果集中。")])])]),s._v(" "),a("li",[s._v("调用引擎接口"),a("code",[s._v("取下一行")]),s._v("。重复第一步的逻辑，直到读到表的最后一行。")]),s._v(" "),a("li",[s._v("将结果集中所有满足条件的记录返回给客户端。")]),s._v(" "),a("li",[s._v("将 SQL语句与搜索结果以 K-V形式存入查询缓存。")])]),s._v(" "),a("hr"),s._v(" "),a("h2",{attrs:{id:"思考问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#思考问题"}},[s._v("#")]),s._v(" 思考问题")]),s._v(" "),a("p",[s._v("如果表 T 中没有字段 k，而你执行了这个语句 "),a("code",[s._v("select * from T where k=1")]),s._v(" , 那肯定是会报“不存在这个列”的错误： “Unknown column ‘k’ in ‘where clause’”。你觉得这个错误是在我们上面提到的哪个阶段报出来的呢？")]),s._v(" "),a("p",[s._v("在分析器的语法分析阶段报出来。")])])}),[],!1,null,null,null);a.default=r.exports}}]);