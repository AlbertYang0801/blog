(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{351:function(s,n,a){"use strict";a.r(n);var e=a(18),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"行锁"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#行锁"}},[s._v("#")]),s._v(" 行锁")]),s._v(" "),n("p",[n("a",{attrs:{href:"https://blog.csdn.net/liuruiaaa/article/details/141458649",target:"_blank",rel:"noopener noreferrer"}},[n("OutboundLink")],1)]),s._v(" "),n("p",[s._v("MySQL 中的行锁（row-level locking）并不是单纯指写锁（write lock），而是指锁定机制的粒度。行锁可以是共享锁（也称为读锁，S锁）或排他锁（也称为写锁，X锁），具体取决于事务所使用的隔离级别以及查询类型。")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("Select for Update")]),s._v("：当执行带有 "),n("code",[s._v("FOR UPDATE")]),s._v(" 子句的 "),n("code",[s._v("SELECT")]),s._v(" 查询时，InnoDB 会对被选中的行加上排他锁。"),n("strong",[s._v("这确保了在事务提交之前，其他事务不能修改这些行")]),s._v("。")]),s._v(" "),n("li",[n("strong",[s._v("Insert Intention Lock")]),s._v("：当执行 "),n("code",[s._v("INSERT")]),s._v(" 操作时，InnoDB 会自动为要插入的行加上意向锁。这是为了避免插入操作与其他事务的 "),n("code",[s._v("UPDATE")]),s._v(" 或 "),n("code",[s._v("DELETE")]),s._v(" 操作冲突。")])]),s._v(" "),n("h2",{attrs:{id:"for-update"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#for-update"}},[s._v("#")]),s._v(" for update")]),s._v(" "),n("p",[n("code",[s._v("SELECT ... FOR UPDATE")]),s._v("语句用于获取行级锁，它能够确保在当前事务持有锁的情况下，其他事务无法读取或修改被锁定的行。")]),s._v(" "),n("h3",{attrs:{id:"for-update-如何工作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#for-update-如何工作"}},[s._v("#")]),s._v(" for update 如何工作？")]),s._v(" "),n("p",[s._v("当执行SELECT … FOR UPDATE时，数据库会对选中的行加上排他锁。这意味着：")]),s._v(" "),n("ul",[n("li",[s._v("锁的作用范围：只有当前事务可以读取或修改这些行，其他事务在试图读取或修改这些行时会被阻塞，直到当前事务结束（提交或回滚）。")]),s._v(" "),n("li",[s._v("事务提交前的状态：在当前事务提交之前，其他事务无法看到这些行的变化，因为锁会阻止其他事务对这些行的访问。")]),s._v(" "),n("li",[s._v("事务提交后的状态：一旦当前事务提交，锁会被释放，其他事务就可以读取这些行的新状态，并且可能对其进行修改。")])]),s._v(" "),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[s._v("select * from messages where id = #"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" and status = 'PENDING' for update\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"测试例子"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试例子"}},[s._v("#")]),s._v(" 测试例子")]),s._v(" "),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 只查询 - 行锁\n     * 第一个事务\n     *\n     * @param id\n     * @return\n     */")]),s._v("\n    @SneakyThrows\n    @Transactional(rollbackFor = Exception.class)\n    @Override\n    public boolean lockQuery(Long id) "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        System.out.println("),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lock 1  start"')]),s._v(");\n        MessagesDo messagesDo = this.getBaseMapper().lockQueryMessageDo(id);\n        System.out.println("),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lock 1  "')]),s._v(" + JSONUtil.toJsonStr(messagesDo));\n        Thread.sleep(10000L);\n        System.out.println("),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lock 1  end"')]),s._v(");\n        return messagesDo != "),n("span",{pre:!0,attrs:{class:"token null keyword"}},[s._v("null")]),s._v(";\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 只查询-行锁\n     * 第二个事务\n     *\n     * @param id\n     * @return\n     */")]),s._v("\n    @SneakyThrows\n    @Transactional(rollbackFor = Exception.class)\n    @Override\n    public boolean lockQuery2(Long id) "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        Thread.sleep(1000L);\n        System.out.println("),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lock 2 start"')]),s._v(");\n        MessagesDo messagesDo = this.getBaseMapper().lockQueryMessageDo(id);\n        System.out.println("),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lock 2  "')]),s._v(" + JSONUtil.toJsonStr(messagesDo));\n        System.out.println("),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lock 2  end"')]),s._v(");\n        return messagesDo != "),n("span",{pre:!0,attrs:{class:"token null keyword"}},[s._v("null")]),s._v(";\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n@SneakyThrows\n    @Test\n    public void lockQuery() "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        ThreadUtil.execAsync(()->messagesService.lockQuery(6L));\n\n        Thread.sleep(1000L);\n        ThreadUtil.execAsync(()->messagesService.lockQuery2(6L));\n\n        Thread.sleep(15000L);\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://s2.loli.net/2025/06/16/sSCf8n9yGhcv6kX.png",alt:""}})]),s._v(" "),n("p",[n("em",[n("strong",[s._v("事务二 会在事务一 commit之前阻塞。")])])]),s._v(" "),n("h3",{attrs:{id:"for-update-非阻塞"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#for-update-非阻塞"}},[s._v("#")]),s._v(" for update 非阻塞")]),s._v(" "),n("p",[n("code",[s._v("for update skip locked")])]),s._v(" "),n("p",[s._v("未获取锁的事务会立即返回。")]),s._v(" "),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[s._v("  @Select("),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"select * from messages where id = #{id} for update skip locked"')]),s._v(")\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);