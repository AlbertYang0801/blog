(window.webpackJsonp=window.webpackJsonp||[]).push([[113],{427:function(t,v,_){"use strict";_.r(v);var r=_(18),a=Object(r.a)({},(function(){var t=this,v=t._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[v("h1",{attrs:{id:"sentinel原理"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#sentinel原理"}},[t._v("#")]),t._v(" Sentinel原理")]),t._v(" "),v("p",[v("a",{attrs:{href:"https://github.com/alibaba/Sentinel/wiki/Sentinel%E5%B7%A5%E4%BD%9C%E4%B8%BB%E6%B5%81%E7%A8%8B",target:"_blank",rel:"noopener noreferrer"}},[t._v("Sentinel工作主流程"),v("OutboundLink")],1)]),t._v(" "),v("p",[v("a",{attrs:{href:"https://www.kancloud.cn/mr_zihan/fix_error/2783766",target:"_blank",rel:"noopener noreferrer"}},[t._v("滑动窗口实现原理 · 吾爱开源 · 看云"),v("OutboundLink")],1)]),t._v(" "),v("h2",{attrs:{id:"限流算法"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#限流算法"}},[t._v("#")]),t._v(" 限流算法")]),t._v(" "),v("h3",{attrs:{id:"计数器算法"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#计数器算法"}},[t._v("#")]),t._v(" 计数器算法")]),t._v(" "),v("p",[t._v("计数器算法统计某个时间段的请求量，判断是否超过阈值。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2025/06/10/zj4MxIZRYkhfU1E.png",alt:""}})]),t._v(" "),v("p",[t._v("存在的问题：")]),t._v(" "),v("p",[t._v("如上图中，在时间段的临界处加起来其实QPS 超过了阈值，但是平均到单个时间段未发生。")]),t._v(" "),v("p",[t._v("单纯的计数器算法存在 "),v("strong",[t._v("临界统计不准确")]),t._v(" 的问题。")]),t._v(" "),v("h3",{attrs:{id:"滑动窗口计数器算法"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#滑动窗口计数器算法"}},[t._v("#")]),t._v(" 滑动窗口计数器算法")]),t._v(" "),v("p",[t._v("解决滑动窗口存在的问题，引入了滑动窗口计数器。")]),t._v(" "),v("p",[t._v("我们将统计时间细分，比如将 1s 统计时长分为 5个 时间窗口，通过 "),v("strong",[t._v("滚动统计所有时间窗口的QPS 作为系统实际的 QPS")]),t._v(" 的方式，就能解决上述 "),v("strong",[t._v("临界统计")]),t._v(" 问题。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2025/06/10/IHrOeQ8f2qWBvmo.png",alt:""}})]),t._v(" "),v("h3",{attrs:{id:"漏斗算法"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#漏斗算法"}},[t._v("#")]),t._v(" 漏斗算法")]),t._v(" "),v("p",[t._v("类似一个队列，每隔10ms从队列头部取出流量进行放行，而我们的队列也就是漏桶，当流量大于队列的长度的时候，我们就可以拒绝超出的部分。")]),t._v(" "),v("p",[t._v("存在的问题：")]),t._v(" "),v("p",[t._v("由于漏斗要求请求比较均匀，不适合突发流量。")]),t._v(" "),v("p",[t._v("适合消费 MQ 这种请求均匀的情况，达到控制请求速率的场景。")]),t._v(" "),v("h3",{attrs:{id:"令牌桶算法"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#令牌桶算法"}},[t._v("#")]),t._v(" 令牌桶算法")]),t._v(" "),v("p",[t._v("令牌桶存放一定数量的令牌，请求过来获取到令牌才会放行。")]),t._v(" "),v("p",[t._v("可以应对突发流量的情况。")]),t._v(" "),v("h2",{attrs:{id:"滑动窗口算法的实现-leaparray"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#滑动窗口算法的实现-leaparray"}},[t._v("#")]),t._v(" 滑动窗口算法的实现-LeapArray")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2025/06/10/rpU3iKyY7NAbxqd.png",alt:""}})]),t._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2025/06/10/esKcDpR8oH1divG.png",alt:""}})]),t._v(" "),v("p",[t._v("滑动窗口将一段时间间隔（"),v("code",[t._v("intervalInMs")]),t._v("）划分成了由 N个（"),v("code",[t._v("sampleCount")]),t._v("）桶（"),v("code",[t._v("Bucket")]),t._v("）组成的时间片数组，每个桶的时间长度是 "),v("code",[t._v("windowLengthInMs")]),t._v("，桶里面保存了统计的相关数据。")]),t._v(" "),v("p",[t._v("对所有有效桶内的 QP（请求量）求和就能得出单位有效时间内的 QPS。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2025/06/10/vLcPUjtGTQBnof2.png",alt:""}})]),t._v(" "),v("ul",[v("li",[v("p",[t._v("情况一：缺少桶，需要创建新桶并更新到数组。")]),t._v(" "),v("p",[t._v("判断当前时间段的桶是否存在，如果不存在，则创建一个新的桶，并尝试使用 CAS 操作将其更新到滑动窗口的桶数组中，如果更新成功，则返回新的桶。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2025/06/10/t9juXv5csD1VMme.png",alt:""}})])]),t._v(" "),v("li",[v("p",[t._v("情况二：最新桶，直接返回。")]),t._v(" "),v("p",[t._v("如果桶已经存在，并且与当前时间段的起始时间相同，则说明这个桶是最新的，可以直接返回。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2025/06/10/SNMPL9FWq3CgJmr.png",alt:""}})]),t._v(" "),v("p",[t._v("image.png")])]),t._v(" "),v("li",[v("p",[t._v("情况三：桶被丢弃，需要重置")]),t._v(" "),v("p",[t._v("如果桶已经存在，但其起始时间已经过期，则需要更新这个桶。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2025/06/10/kD9oMFEzpq6SlWi.png",alt:""}})])])]),t._v(" "),v("h2",{attrs:{id:"关键类"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#关键类"}},[t._v("#")]),t._v(" 关键类")]),t._v(" "),v("ul",[v("li",[v("code",[t._v("StatisticNode")])]),t._v(" "),v("li",[v("code",[t._v("StatisticSlot")])]),t._v(" "),v("li",[v("code",[t._v("ArrayMetric")])]),t._v(" "),v("li",[v("code",[t._v("LeapArray")])])]),t._v(" "),v("p",[t._v("当 Sentinel 监控系统对某个资源进行监控时，会创建一个对应的 StatisticNode 节点。")]),t._v(" "),v("p",[t._v("该节点通过 StatisticSlot 统计槽收集和处理数据。")]),t._v(" "),v("p",[t._v("并通过 ArrayMetric 数组度量器来维护收集的数据。")]),t._v(" "),v("p",[t._v("LeapArray 则相当于一个滑动时间窗口，用于按照时间周期将各个 ArrayMetric 链接起来，以形成一个时间线的统计图。")]),t._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2025/06/10/mkrRENuLOba5FH9.png",alt:""}})]),t._v(" "),v("h2",{attrs:{id:"同类组件功能对比"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#同类组件功能对比"}},[t._v("#")]),t._v(" 同类组件功能对比")]),t._v(" "),v("table",[v("thead",[v("tr",[v("th"),t._v(" "),v("th",[t._v("Sentinel")]),t._v(" "),v("th",[t._v("Hystrix")]),t._v(" "),v("th",[t._v("resilience4j")])])]),t._v(" "),v("tbody",[v("tr",[v("td",[t._v("隔离策略")]),t._v(" "),v("td",[t._v("信号量隔离（并发控制）")]),t._v(" "),v("td",[t._v("线程池隔离/信号量隔离")]),t._v(" "),v("td",[t._v("信号量隔离")])]),t._v(" "),v("tr",[v("td",[t._v("熔断降级策略")]),t._v(" "),v("td",[t._v("基于慢调用比例、异常比例、异常数")]),t._v(" "),v("td",[t._v("基于异常比例")]),t._v(" "),v("td",[t._v("基于异常比例、响应时间")])]),t._v(" "),v("tr",[v("td",[t._v("实时统计实现")]),t._v(" "),v("td",[t._v("滑动窗口（LeapArray）")]),t._v(" "),v("td",[t._v("滑动窗口（基于 RxJava）")]),t._v(" "),v("td",[t._v("Ring Bit Buffer")])]),t._v(" "),v("tr",[v("td",[t._v("动态规则配置")]),t._v(" "),v("td",[t._v("支持近十种动态数据源")]),t._v(" "),v("td",[t._v("支持多种数据源")]),t._v(" "),v("td",[t._v("有限支持")])]),t._v(" "),v("tr",[v("td",[t._v("扩展性")]),t._v(" "),v("td",[t._v("多个扩展点")]),t._v(" "),v("td",[t._v("插件的形式")]),t._v(" "),v("td",[t._v("接口的形式")])]),t._v(" "),v("tr",[v("td",[t._v("基于注解的支持")]),t._v(" "),v("td",[t._v("支持")]),t._v(" "),v("td",[t._v("支持")]),t._v(" "),v("td",[t._v("支持")])]),t._v(" "),v("tr",[v("td",[t._v("单机限流")]),t._v(" "),v("td",[t._v("基于 QPS，支持基于调用关系的限流")]),t._v(" "),v("td",[t._v("有限的支持")]),t._v(" "),v("td",[t._v("Rate Limiter")])]),t._v(" "),v("tr",[v("td",[t._v("集群流控")]),t._v(" "),v("td",[t._v("支持")]),t._v(" "),v("td",[t._v("不支持")]),t._v(" "),v("td",[t._v("不支持")])]),t._v(" "),v("tr",[v("td",[t._v("流量整形")]),t._v(" "),v("td",[t._v("支持预热模式与匀速排队控制效果")]),t._v(" "),v("td",[t._v("不支持")]),t._v(" "),v("td",[t._v("简单的 Rate Limiter 模式")])]),t._v(" "),v("tr",[v("td",[t._v("系统自适应保护")]),t._v(" "),v("td",[t._v("支持")]),t._v(" "),v("td",[t._v("不支持")]),t._v(" "),v("td",[t._v("不支持")])]),t._v(" "),v("tr",[v("td",[t._v("热点识别/防护")]),t._v(" "),v("td",[t._v("支持")]),t._v(" "),v("td",[t._v("不支持")]),t._v(" "),v("td",[t._v("不支持")])]),t._v(" "),v("tr",[v("td",[t._v("多语言支持")]),t._v(" "),v("td",[t._v("Java/Go/C++")]),t._v(" "),v("td",[t._v("Java")]),t._v(" "),v("td",[t._v("Java")])]),t._v(" "),v("tr",[v("td",[t._v("Service Mesh 支持")]),t._v(" "),v("td",[t._v("支持 Envoy/Istio")]),t._v(" "),v("td",[t._v("不支持")]),t._v(" "),v("td",[t._v("不支持")])]),t._v(" "),v("tr",[v("td",[t._v("控制台")]),t._v(" "),v("td",[t._v("提供开箱即用的控制台，可配置规则、实时监控、机器发现等")]),t._v(" "),v("td",[t._v("简单的监控查看")]),t._v(" "),v("td",[t._v("不提供控制台，可对接其它监控系统")])])])]),t._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2025/06/10/C5wsJjVGdoDgl91.png",alt:""}})]),t._v(" "),v("ul",[v("li",[t._v("线程池隔离：\n"),v("ol",[v("li",[t._v("调用线程和 hystrixCommand 线程不是同一个线程，并发请求数受到线程池（不是容器 tomcat 的线程池，而是 hystrixCommand 所属于线程组的线程池）中的线程数限制，默认是10。")]),t._v(" "),v("li",[t._v("这个是默认的隔离机制。")]),t._v(" "),v("li",[t._v("hystrixCommand 线程无法获取到调用线程中的 ThreadLocal 中的值。")])])]),t._v(" "),v("li",[t._v("信号量隔离：\n"),v("ol",[v("li",[t._v("调用线程和 hystrixCommand 线程是同一个线程，默认最大并发请求数是10。")]),t._v(" "),v("li",[t._v("调用数度快，开销小，由于和调用线程是处于同一个线程，所以必须确保调用的微服务可用性足够高并且返回快才用。")])])])]),t._v(" "),v("p",[t._v("注意：如果发生找不到上下文的运行时异常，可考虑将隔离策略设置为 SEMAPHONE。")]),t._v(" "),v("h2",{attrs:{id:"参考链接"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[t._v("#")]),t._v(" 参考链接")]),t._v(" "),v("p",[v("a",{attrs:{href:"https://blog.csdn.net/Michelle_Zhong/article/details/131144748",target:"_blank",rel:"noopener noreferrer"}},[t._v("【RuoYi-Cloud-Plus】学习笔记 06 - Sentinel（一）关于 StatisticSlot 以及 LeapArray_sentinel leaparray-CSDN博客"),v("OutboundLink")],1)]),t._v(" "),v("p",[v("a",{attrs:{href:"https://www.processon.com/view/link/62e24778e0b34d06e56ab4b9",target:"_blank",rel:"noopener noreferrer"}},[t._v("Sentinel 1.8.4 规则持久化源码分析| ProcessOn免费在线作图,在线流程图,在线思维导图"),v("OutboundLink")],1)]),t._v(" "),v("h2",{attrs:{id:"思考"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#思考"}},[t._v("#")]),t._v(" 思考")]),t._v(" "),v("h3",{attrs:{id:"告警压缩功能可以用滑动窗口去做吗"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#告警压缩功能可以用滑动窗口去做吗"}},[t._v("#")]),t._v(" 告警压缩功能可以用滑动窗口去做吗")]),t._v(" "),v("ul",[v("li",[t._v("告警压缩也是用滑动窗口实现。\n"),v("ul",[v("li",[t._v("比如一分钟内同机器CPU超过80告警。针对机器生成一个时间桶，写入数据时判断桶内数据是否达到阈值。")])])])])])}),[],!1,null,null,null);v.default=a.exports}}]);