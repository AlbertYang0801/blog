import{_ as a,c as n,o as i,aN as l}from"./chunks/framework.A-MC8nKA.js";const d=JSON.parse('{"title":"日志收集全链路","description":"","frontmatter":{},"headers":[],"relativePath":"other/observability/log/index.md","filePath":"other/observability/log/index.md","lastUpdated":1755162615000}'),e={name:"other/observability/log/index.md"};function p(t,s,r,h,k,o){return i(),n("div",null,s[0]||(s[0]=[l(`<h1 id="日志收集全链路" tabindex="-1">日志收集全链路 <a class="header-anchor" href="#日志收集全链路" aria-label="Permalink to &quot;日志收集全链路&quot;">​</a></h1><h2 id="elfk" tabindex="-1">ELFK <a class="header-anchor" href="#elfk" aria-label="Permalink to &quot;ELFK&quot;">​</a></h2><p>ELFK 指的是 elasticsearch+logstash+filebeat+kibana</p><h3 id="日志管理" tabindex="-1">日志管理 <a class="header-anchor" href="#日志管理" aria-label="Permalink to &quot;日志管理&quot;">​</a></h3><p>日志收集→格式化分析→检索和可视化→日志告警</p><p><img src="https://s2.loli.net/2025/07/16/JtsXzkTbKPh1c4H.png" alt="image.png" loading="lazy"></p><h3 id="日志架构" tabindex="-1">日志架构 <a class="header-anchor" href="#日志架构" aria-label="Permalink to &quot;日志架构&quot;">​</a></h3><h4 id="小规模环境" tabindex="-1">小规模环境 <a class="header-anchor" href="#小规模环境" aria-label="Permalink to &quot;小规模环境&quot;">​</a></h4><p><img src="https://s2.loli.net/2025/07/16/zd3eOvFMg2PQZYK.png" alt="image.png" loading="lazy"></p><p><img src="https://s2.loli.net/2025/07/16/CpAiqwokbmTxXrF.png" alt="image.png" loading="lazy"></p><h3 id="大规模生产环境" tabindex="-1">大规模生产环境 <a class="header-anchor" href="#大规模生产环境" aria-label="Permalink to &quot;大规模生产环境&quot;">​</a></h3><p>ELFK + Kafka</p><h3 id="logstash" tabindex="-1">Logstash <a class="header-anchor" href="#logstash" aria-label="Permalink to &quot;Logstash&quot;">​</a></h3><p>从多个来源采集数据，转换数据，然后将数据放到不同的数据库中。</p><p>da 就很像 logstash 的功能设计。</p><h4 id="架构" tabindex="-1">架构 <a class="header-anchor" href="#架构" aria-label="Permalink to &quot;架构&quot;">​</a></h4><p><img src="https://s2.loli.net/2025/07/16/dWwuoypQDrPgvqA.png" alt="image.png" loading="lazy"></p><p>Logstash 接入数据源数据，经过内部 Pipeline，将数据可以写到不同的存储（ES、Kafka）里面。</p><p>Logstash内部包含 Input、Filter（可选）、OutPut 插件。</p><ul><li>Input</li></ul><p>​ <a href="https://www.elastic.co/guide/en/logstash/7.17/input-plugins.html" target="_blank" rel="noreferrer">Input plugins | Logstash Reference [7.17] | Elastic</a></p><ul><li>Output</li></ul><p>​ <a href="https://www.elastic.co/guide/en/logstash/7.17/output-plugins.html" target="_blank" rel="noreferrer">Output plugins | Logstash Reference [7.17] | Elastic</a></p><ul><li>Filter</li></ul><p>​ <a href="https://www.elastic.co/guide/en/logstash/7.17/filter-plugins.html" target="_blank" rel="noreferrer">Filter plugins | Logstash Reference [7.17] | Elastic</a></p><h4 id="kafka" tabindex="-1">Kafka <a class="header-anchor" href="#kafka" aria-label="Permalink to &quot;Kafka&quot;">​</a></h4><p>数据发给Kafka。</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    input {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      beats {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        port </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5044</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    output {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([log_topic]){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        kafka{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          topic_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;%{log_topic}&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          bootstrap_servers </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;kafka-svc:59092&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          codec </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;json&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        kafka{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">           topic_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;systemlog&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          bootstrap_servers </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;kafka-svc:59092&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          codec </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;json&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="es" tabindex="-1">Es <a class="header-anchor" href="#es" aria-label="Permalink to &quot;Es&quot;">​</a></h4><p>数据发给es。</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>    input {</span></span>
<span class="line"><span>      beats {</span></span>
<span class="line"><span>        port =&gt; 5044</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    output {</span></span>
<span class="line"><span>      if([log_topic]){</span></span>
<span class="line"><span>        elasticsearch {</span></span>
<span class="line"><span>          hosts =&gt; [&quot;10.10.103.35:39200&quot;]</span></span>
<span class="line"><span>          index =&gt; &quot;apm2.0-%{masterIp}-%{log_topic}-%{+YYYY.MM.dd}&quot;</span></span>
<span class="line"><span>          user =&gt; &quot;elastic&quot;</span></span>
<span class="line"><span>          password =&gt; &quot;Hc@Cloud01&quot;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>       stdout { codec =&gt; rubydebug }</span></span>
<span class="line"><span>      }else{</span></span>
<span class="line"><span>        elasticsearch {</span></span>
<span class="line"><span>          hosts =&gt; [&quot;10.10.103.35:39200&quot;]</span></span>
<span class="line"><span>          index =&gt; &quot;apm2.0-yanshi_default_default_system-%{+YYYY.MM.dd}&quot;</span></span>
<span class="line"><span>          user =&gt; &quot;elastic&quot;</span></span>
<span class="line"><span>          password =&gt; &quot;Hc@Cloud01&quot;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>       stdout { codec =&gt; rubydebug }</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="filebeat" tabindex="-1">Filebeat <a class="header-anchor" href="#filebeat" aria-label="Permalink to &quot;Filebeat&quot;">​</a></h3><p>Filebeat专门用于转发和收集日志数据的轻量级采集工具。</p><p>它可以作为代理安装在服务器上，Filebeat<strong>监视指定路径的日志文件</strong>，收集日志数据，并将收集到的日志转发到Elasticsearch或者Logstash。</p><h4 id="工作原理" tabindex="-1">工作原理 <a class="header-anchor" href="#工作原理" aria-label="Permalink to &quot;工作原理&quot;">​</a></h4><p><img src="https://s2.loli.net/2025/07/16/wNy73utR859rVjb.png" alt="image.png" loading="lazy"></p><ul><li>启动FileBeat时，会启动多个输入（Input），这些Input监控指定的日志数据位置。</li><li>FileBeat会针对每一个文件启动一个Harvester（收割机）。</li><li>Harvester读取每一个文件的日志，将新的日志发送到libbeat，libbeat将数据收集到一起，并将数据发送给输出（Output）。</li></ul><p>FileBeat 是基于 golang 编写的，功能较少但资源消耗也比较小，更轻量级。</p><h4 id="配置" tabindex="-1">配置 <a class="header-anchor" href="#配置" aria-label="Permalink to &quot;配置&quot;">​</a></h4><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 请放置到inputs.d文件夹下,无需重启filebeat</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">log</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  ignore_older</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">60h</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  paths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/home/tomcat/apache-tomcat/logs/*.log</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/home/tomcat/apache-tomcat/logs/*.out</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/home/tomcat/logs/*.log</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  fields_under_root</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  fields</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    masterIp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">yanshi_default_default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    app_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">boper</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    host_ip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10.10.102.88</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    log_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">app</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    env_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">vm</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    log_topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">logserver</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="容器采集" tabindex="-1">容器采集 <a class="header-anchor" href="#容器采集" aria-label="Permalink to &quot;容器采集&quot;">​</a></h4><p>Filebeat 原生不支持容器内文件采集，需要人工将日志挂在于宿主机HostPath。</p><blockquote><p>因为Filebeat没有容器相关信息，所以不知道容器动态挂载的文件路径。Ilogtail维护了容器列表，不需要人工挂载。</p></blockquote><h2 id="ilogtail" tabindex="-1">Ilogtail <a class="header-anchor" href="#ilogtail" aria-label="Permalink to &quot;Ilogtail&quot;">​</a></h2><p><a href="https://ilogtail.gitbook.io/ilogtail-docs" target="_blank" rel="noreferrer">https://ilogtail.gitbook.io/ilogtail-docs</a></p><p>阿里云开源的日志采集探针，性能更好，可以替代Filebeat。</p><blockquote><p>iLogtail 为可观测场景而生，拥有的轻量级、高性能、自动化配置等诸多生产级别特性，在阿里巴巴以及外部数万家阿里云客户内部广泛应用。你可以将它部署于物理机，虚拟机，Kubernetes等多种环境中来采集遥测数据，例如logs、traces和metrics。</p></blockquote><p><a href="https://ilogtail.gitbook.io/ilogtail-docs/benchmark/performance-compare-with-filebeat" target="_blank" rel="noreferrer">容器场景iLogtail与Filebeat性能对比测试</a></p><p><img src="https://s2.loli.net/2025/07/16/cQzZBpa8oVuK7kl.png" alt="image-20250716150410294" loading="lazy"></p>`,49)]))}const b=a(e,[["render",p]]);export{d as __pageData,b as default};
